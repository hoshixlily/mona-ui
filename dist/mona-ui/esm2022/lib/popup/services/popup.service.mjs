import { Injectable, Injector, TemplateRef } from "@angular/core";
import { ComponentPortal, TemplatePortal } from "@angular/cdk/portal";
import { PopupRef } from "../models/PopupRef";
import { PopupInjectionToken } from "../models/PopupInjectionToken";
import { DefaultPositions } from "../models/DefaultPositions";
import { fromEvent, Subject, take, takeUntil } from "rxjs";
import { PopupCloseEvent, PopupCloseSource } from "../models/PopupCloseEvent";
import { Dictionary } from "@mirei/ts-collections";
import { v4 } from "uuid";
import { PopupReference } from "../models/PopupReference";
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/overlay";
export class PopupService {
    constructor(injector, overlay, rendererFactory, zone) {
        this.injector = injector;
        this.overlay = overlay;
        this.rendererFactory = rendererFactory;
        this.zone = zone;
        this.outsideEventsToClose = ["click", "mousedown", "dblclick", "contextmenu", "auxclick"];
        this.popupStateMap = new Dictionary();
        this.serviceDestroy$ = new Subject();
        this.renderer = rendererFactory.createRenderer(null, null);
    }
    create(settings) {
        const uid = v4();
        let positionStrategy;
        if (settings.positionStrategy === "global") {
            positionStrategy = this.overlay.position().global();
        }
        else {
            positionStrategy = this.overlay
                .position()
                .flexibleConnectedTo(settings.anchor)
                .withPositions(settings.positions ?? DefaultPositions)
                .withDefaultOffsetX(settings.offset?.horizontal ?? 0)
                .withDefaultOffsetY(settings.offset?.vertical ?? 0)
                .withPush(settings.withPush ?? true);
        }
        const panelClass = settings.popupClass
            ? ["mona-popup-content"].concat(settings.popupClass)
            : "mona-popup-content";
        const overlayRef = this.overlay.create({
            positionStrategy,
            hasBackdrop: settings.hasBackdrop ?? true,
            height: settings.height,
            maxHeight: settings.maxHeight,
            maxWidth: settings.maxWidth,
            minHeight: settings.minHeight,
            minWidth: settings.minWidth,
            width: settings.width,
            panelClass,
            backdropClass: settings.backdropClass ?? "transparent"
        });
        const preventClose = settings.preventClose;
        const popupReference = new PopupReference(overlayRef);
        const injector = Injector.create({
            parent: this.injector,
            providers: [
                { provide: PopupRef, useFactory: () => popupReference.popupRef },
                { provide: PopupInjectionToken, useValue: settings.data },
                ...(settings.providers ?? [])
            ]
        });
        let portal;
        if (settings.content instanceof TemplateRef) {
            portal = new TemplatePortal(settings.content, PopupService.popupAnchorDirective.viewContainerRef, null, injector);
            overlayRef.attach(portal);
        }
        else {
            portal = new ComponentPortal(settings.content, PopupService.popupAnchorDirective.viewContainerRef, injector);
            popupReference.componentRef = overlayRef.attach(portal);
        }
        if (settings.hasBackdrop) {
            if (settings.closeOnBackdropClick ?? true) {
                const backdropSubject = new Subject();
                const subscription = overlayRef
                    .backdropClick()
                    .pipe(takeUntil(backdropSubject))
                    .subscribe(e => {
                    const event = new PopupCloseEvent({ event: e, via: PopupCloseSource.BackdropClick });
                    const prevented = preventClose ? preventClose(event) || event.isDefaultPrevented() : false;
                    if (!prevented) {
                        popupReference.close(event);
                        this.popupStateMap.remove(uid);
                        backdropSubject.next();
                        backdropSubject.complete();
                    }
                });
                popupReference.closed.pipe(take(1)).subscribe(() => subscription.unsubscribe());
            }
        }
        else {
            if (settings.closeOnOutsideClick ?? true) {
                const subscription = overlayRef
                    .outsidePointerEvents()
                    .pipe(takeUntil(this.serviceDestroy$))
                    .subscribe(event => {
                    if (this.outsideEventsToClose.includes(event.type)) {
                        const closeEvent = new PopupCloseEvent({ event, via: PopupCloseSource.OutsideClick });
                        const prevented = preventClose
                            ? preventClose(closeEvent) || closeEvent.isDefaultPrevented()
                            : false;
                        if (!prevented) {
                            popupReference.close(closeEvent);
                            this.popupStateMap.remove(uid);
                            subscription.unsubscribe();
                        }
                    }
                });
                popupReference.closed.pipe(take(1)).subscribe(() => subscription.unsubscribe());
            }
        }
        popupReference.closed.pipe(take(1)).subscribe(() => {
            this.popupStateMap.remove(uid);
        });
        this.popupStateMap.add(uid, {
            uid,
            popupRef: popupReference.popupRef,
            settings
        });
        this.setEventListeners(this.popupStateMap.get(uid));
        return popupReference.popupRef;
    }
    ngOnDestroy() {
        this.serviceDestroy$.next();
        this.serviceDestroy$.complete();
    }
    setEventListeners(state) {
        this.zone.runOutsideAngular(() => {
            if (state.settings.closeOnEscape ?? true) {
                fromEvent(document, "keydown")
                    .pipe(takeUntil(state.popupRef.closed))
                    .subscribe(event => {
                    if (event.key === "Escape") {
                        const closeEvent = new PopupCloseEvent({ event, via: PopupCloseSource.Escape });
                        const prevented = state.settings.preventClose
                            ? state.settings.preventClose(closeEvent) || closeEvent.isDefaultPrevented()
                            : false;
                        if (!prevented) {
                            this.zone.run(() => {
                                state.popupRef.close(closeEvent);
                                this.popupStateMap.remove(state.uid);
                            });
                        }
                    }
                });
            }
        });
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: PopupService, deps: [{ token: i0.Injector }, { token: i1.Overlay }, { token: i0.RendererFactory2 }, { token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: PopupService, providedIn: "root" }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: PopupService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: "root"
                }]
        }], ctorParameters: function () { return [{ type: i0.Injector }, { type: i1.Overlay }, { type: i0.RendererFactory2 }, { type: i0.NgZone }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wdXAuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL21vbmEtdWkvc3JjL2xpYi9wb3B1cC9zZXJ2aWNlcy9wb3B1cC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFrRCxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHbEgsT0FBTyxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUV0RSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDOUMsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDcEUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDOUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzRCxPQUFPLEVBQUUsZUFBZSxFQUFFLGdCQUFnQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDOUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRW5ELE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDMUIsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDBCQUEwQixDQUFDOzs7QUFLMUQsTUFBTSxPQUFPLFlBQVk7SUFPckIsWUFDcUIsUUFBa0IsRUFDbEIsT0FBZ0IsRUFDaEIsZUFBaUMsRUFDakMsSUFBWTtRQUhaLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUNoQixvQkFBZSxHQUFmLGVBQWUsQ0FBa0I7UUFDakMsU0FBSSxHQUFKLElBQUksQ0FBUTtRQVRoQix5QkFBb0IsR0FBRyxDQUFDLE9BQU8sRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFF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WUFBWSxDQUFDLFVBQVUsQ0FBQyxJQUFJLFVBQVUsQ0FBQyxrQkFBa0IsRUFBRTs0QkFDNUUsQ0FBQyxDQUFDLEtBQUssQ0FBQzt3QkFDWixJQUFJLENBQUMsU0FBUyxFQUFFOzRCQUNaLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRTtnQ0FDZixLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztnQ0FDakMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDOzRCQUN6QyxDQUFDLENBQUMsQ0FBQzt5QkFDTjtxQkFDSjtnQkFDTCxDQUFDLENBQUMsQ0FBQzthQUNWO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDOzhHQTNKUSxZQUFZO2tIQUFaLFlBQVksY0FGVCxNQUFNOzsyRkFFVCxZQUFZO2tCQUh4QixVQUFVO21CQUFDO29CQUNSLFVBQVUsRUFBRSxNQUFNO2lCQUNyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBOZ1pvbmUsIE9uRGVzdHJveSwgUmVuZGVyZXIyLCBSZW5kZXJlckZhY3RvcnkyLCBUZW1wbGF0ZVJlZiB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBQb3B1cFNldHRpbmdzIH0gZnJvbSBcIi4uL21vZGVscy9Qb3B1cFNldHRpbmdzXCI7XG5pbXBvcnQgeyBPdmVybGF5LCBQb3NpdGlvblN0cmF0ZWd5IH0gZnJvbSBcIkBhbmd1bGFyL2Nkay9vdmVybGF5XCI7XG5pbXBvcnQgeyBDb21wb25lbnRQb3J0YWwsIFRlbXBsYXRlUG9ydGFsIH0gZnJvbSBcIkBhbmd1bGFyL2Nkay9wb3J0YWxcIjtcbmltcG9ydCB7IFBvcHVwQW5jaG9yRGlyZWN0aXZlIH0gZnJvbSBcIi4uL2RpcmVjdGl2ZXMvcG9wdXAtYW5jaG9yLmRpcmVjdGl2ZVwiO1xuaW1wb3J0IHsgUG9wdXBSZWYgfSBmcm9tIFwiLi4vbW9kZWxzL1BvcHVwUmVmXCI7XG5pbXBvcnQgeyBQb3B1cEluamVjdGlvblRva2VuIH0gZnJvbSBcIi4uL21vZGVscy9Qb3B1cEluamVjdGlvblRva2VuXCI7XG5pbXBvcnQgeyBEZWZhdWx0UG9zaXRpb25zIH0gZnJvbSBcIi4uL21vZGVscy9EZWZhdWx0UG9zaXRpb25zXCI7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIFN1YmplY3QsIHRha2UsIHRha2VVbnRpbCB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyBQb3B1cENsb3NlRXZlbnQsIFBvcHVwQ2xvc2VTb3VyY2UgfSBmcm9tIFwiLi4vbW9kZWxzL1BvcHVwQ2xvc2VFdmVudFwiO1xuaW1wb3J0IHsgRGljdGlvbmFyeSB9IGZyb20gXCJAbWlyZWkvdHMtY29sbGVjdGlvbnNcIjtcbmltcG9ydCB7IFBvcHVwU3RhdGUgfSBmcm9tIFwiLi4vbW9kZWxzL1BvcHVwU3RhdGVcIjtcbmltcG9ydCB7IHY0IH0gZnJvbSBcInV1aWRcIjtcbmltcG9ydCB7IFBvcHVwUmVmZXJlbmNlIH0gZnJvbSBcIi4uL21vZGVscy9Qb3B1cFJlZmVyZW5jZVwiO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogXCJyb290XCJcbn0pXG5leHBvcnQgY2xhc3MgUG9wdXBTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgICBwdWJsaWMgc3RhdGljIHBvcHVwQW5jaG9yRGlyZWN0aXZlOiBQb3B1cEFuY2hvckRpcmVjdGl2ZTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHNpZGVFdmVudHNUb0Nsb3NlID0gW1wiY2xpY2tcIiwgXCJtb3VzZWRvd25cIiwgXCJkYmxjbGlja1wiLCBcImNvbnRleHRtZW51XCIsIFwiYXV4Y2xpY2tcIl07XG4gICAgcHJpdmF0ZSByZWFkb25seSBwb3B1cFN0YXRlTWFwOiBEaWN0aW9uYXJ5PHN0cmluZywgUG9wdXBTdGF0ZT4gPSBuZXcgRGljdGlvbmFyeTxzdHJpbmcsIFBvcHVwU3RhdGU+KCk7XG4gICAgcHJpdmF0ZSByZWFkb25seSBzZXJ2aWNlRGVzdHJveSQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMjtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgb3ZlcmxheTogT3ZlcmxheSxcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSByZW5kZXJlckZhY3Rvcnk6IFJlbmRlcmVyRmFjdG9yeTIsXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgem9uZTogTmdab25lXG4gICAgKSB7XG4gICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlckZhY3RvcnkuY3JlYXRlUmVuZGVyZXIobnVsbCwgbnVsbCk7XG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZShzZXR0aW5nczogUG9wdXBTZXR0aW5ncyk6IFBvcHVwUmVmIHtcbiAgICAgICAgY29uc3QgdWlkID0gdjQoKTtcbiAgICAgICAgbGV0IHBvc2l0aW9uU3RyYXRlZ3k6IFBvc2l0aW9uU3RyYXRlZ3k7XG4gICAgICAgIGlmIChzZXR0aW5ncy5wb3NpdGlvblN0cmF0ZWd5ID09PSBcImdsb2JhbFwiKSB7XG4gICAgICAgICAgICBwb3NpdGlvblN0cmF0ZWd5ID0gdGhpcy5vdmVybGF5LnBvc2l0aW9uKCkuZ2xvYmFsKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBwb3NpdGlvblN0cmF0ZWd5ID0gdGhpcy5vdmVybGF5XG4gICAgICAgICAgICAgICAgLnBvc2l0aW9uKClcbiAgICAgICAgICAgICAgICAuZmxleGlibGVDb25uZWN0ZWRUbyhzZXR0aW5ncy5hbmNob3IpXG4gICAgICAgICAgICAgICAgLndpdGhQb3NpdGlvbnMoc2V0dGluZ3MucG9zaXRpb25zID8/IERlZmF1bHRQb3NpdGlvbnMpXG4gICAgICAgICAgICAgICAgLndpdGhEZWZhdWx0T2Zmc2V0WChzZXR0aW5ncy5vZmZzZXQ/Lmhvcml6b250YWwgPz8gMClcbiAgICAgICAgICAgICAgICAud2l0aERlZmF1bHRPZmZzZXRZKHNldHRpbmdzLm9mZnNldD8udmVydGljYWwgPz8gMClcbiAgICAgICAgICAgICAgICAud2l0aFB1c2goc2V0dGluZ3Mud2l0aFB1c2ggPz8gdHJ1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwYW5lbENsYXNzID0gc2V0dGluZ3MucG9wdXBDbGFzc1xuICAgICAgICAgICAgPyBbXCJtb25hLXBvcHVwLWNvbnRlbnRcIl0uY29uY2F0KHNldHRpbmdzLnBvcHVwQ2xhc3MpXG4gICAgICAgICAgICA6IFwibW9uYS1wb3B1cC1jb250ZW50XCI7XG5cbiAgICAgICAgY29uc3Qgb3ZlcmxheVJlZiA9IHRoaXMub3ZlcmxheS5jcmVhdGUoe1xuICAgICAgICAgICAgcG9zaXRpb25TdHJhdGVneSxcbiAgICAgICAgICAgIGhhc0JhY2tkcm9wOiBzZXR0aW5ncy5oYXNCYWNrZHJvcCA/PyB0cnVlLFxuICAgICAgICAgICAgaGVpZ2h0OiBzZXR0aW5ncy5oZWlnaHQsXG4gICAgICAgICAgICBtYXhIZWlnaHQ6IHNldHRpbmdzLm1heEhlaWdodCxcbiAgICAgICAgICAgIG1heFdpZHRoOiBzZXR0aW5ncy5tYXhXaWR0aCxcbiAgICAgICAgICAgIG1pbkhlaWdodDogc2V0dGluZ3MubWluSGVpZ2h0LFxuICAgICAgICAgICAgbWluV2lkdGg6IHNldHRpbmdzLm1pbldpZHRoLFxuICAgICAgICAgICAgd2lkdGg6IHNldHRpbmdzLndpZHRoLFxuICAgICAgICAgICAgcGFuZWxDbGFzcyxcbiAgICAgICAgICAgIGJhY2tkcm9wQ2xhc3M6IHNldHRpbmdzLmJhY2tkcm9wQ2xhc3MgPz8gXCJ0cmFuc3BhcmVudFwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHByZXZlbnRDbG9zZSA9IHNldHRpbmdzLnByZXZlbnRDbG9zZTtcbiAgICAgICAgY29uc3QgcG9wdXBSZWZlcmVuY2UgPSBuZXcgUG9wdXBSZWZlcmVuY2Uob3ZlcmxheVJlZik7XG5cbiAgICAgICAgY29uc3QgaW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgICAgICAgcGFyZW50OiB0aGlzLmluamVjdG9yLFxuICAgICAgICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgICAgICAgICAgeyBwcm92aWRlOiBQb3B1cFJlZiwgdXNlRmFjdG9yeTogKCkgPT4gcG9wdXBSZWZlcmVuY2UucG9wdXBSZWYgfSxcbiAgICAgICAgICAgICAgICB7IHByb3ZpZGU6IFBvcHVwSW5qZWN0aW9uVG9rZW4sIHVzZVZhbHVlOiBzZXR0aW5ncy5kYXRhIH0sXG4gICAgICAgICAgICAgICAgLi4uKHNldHRpbmdzLnByb3ZpZGVycyA/PyBbXSlcbiAgICAgICAgICAgIF1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHBvcnRhbDogVGVtcGxhdGVQb3J0YWwgfCBDb21wb25lbnRQb3J0YWw8dm9pZD47XG4gICAgICAgIGlmIChzZXR0aW5ncy5jb250ZW50IGluc3RhbmNlb2YgVGVtcGxhdGVSZWYpIHtcbiAgICAgICAgICAgIHBvcnRhbCA9IG5ldyBUZW1wbGF0ZVBvcnRhbChcbiAgICAgICAgICAgICAgICBzZXR0aW5ncy5jb250ZW50LFxuICAgICAgICAgICAgICAgIFBvcHVwU2VydmljZS5wb3B1cEFuY2hvckRpcmVjdGl2ZS52aWV3Q29udGFpbmVyUmVmLFxuICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgICAgaW5qZWN0b3JcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBvdmVybGF5UmVmLmF0dGFjaChwb3J0YWwpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcG9ydGFsID0gbmV3IENvbXBvbmVudFBvcnRhbChcbiAgICAgICAgICAgICAgICBzZXR0aW5ncy5jb250ZW50LFxuICAgICAgICAgICAgICAgIFBvcHVwU2VydmljZS5wb3B1cEFuY2hvckRpcmVjdGl2ZS52aWV3Q29udGFpbmVyUmVmLFxuICAgICAgICAgICAgICAgIGluamVjdG9yXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcG9wdXBSZWZlcmVuY2UuY29tcG9uZW50UmVmID0gb3ZlcmxheVJlZi5hdHRhY2gocG9ydGFsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzZXR0aW5ncy5oYXNCYWNrZHJvcCkge1xuICAgICAgICAgICAgaWYgKHNldHRpbmdzLmNsb3NlT25CYWNrZHJvcENsaWNrID8/IHRydWUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBiYWNrZHJvcFN1YmplY3Q6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IG92ZXJsYXlSZWZcbiAgICAgICAgICAgICAgICAgICAgLmJhY2tkcm9wQ2xpY2soKVxuICAgICAgICAgICAgICAgICAgICAucGlwZSh0YWtlVW50aWwoYmFja2Ryb3BTdWJqZWN0KSlcbiAgICAgICAgICAgICAgICAgICAgLnN1YnNjcmliZShlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGV2ZW50ID0gbmV3IFBvcHVwQ2xvc2VFdmVudCh7IGV2ZW50OiBlLCB2aWE6IFBvcHVwQ2xvc2VTb3VyY2UuQmFja2Ryb3BDbGljayB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHByZXZlbnRlZCA9IHByZXZlbnRDbG9zZSA/IHByZXZlbnRDbG9zZShldmVudCkgfHwgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgOiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcHJldmVudGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9wdXBSZWZlcmVuY2UuY2xvc2UoZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBTdGF0ZU1hcC5yZW1vdmUodWlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZHJvcFN1YmplY3QubmV4dCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tkcm9wU3ViamVjdC5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBwb3B1cFJlZmVyZW5jZS5jbG9zZWQucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUoKCkgPT4gc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHNldHRpbmdzLmNsb3NlT25PdXRzaWRlQ2xpY2sgPz8gdHJ1ZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IG92ZXJsYXlSZWZcbiAgICAgICAgICAgICAgICAgICAgLm91dHNpZGVQb2ludGVyRXZlbnRzKClcbiAgICAgICAgICAgICAgICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuc2VydmljZURlc3Ryb3kkKSlcbiAgICAgICAgICAgICAgICAgICAgLnN1YnNjcmliZShldmVudCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdXRzaWRlRXZlbnRzVG9DbG9zZS5pbmNsdWRlcyhldmVudC50eXBlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsb3NlRXZlbnQgPSBuZXcgUG9wdXBDbG9zZUV2ZW50KHsgZXZlbnQsIHZpYTogUG9wdXBDbG9zZVNvdXJjZS5PdXRzaWRlQ2xpY2sgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJldmVudGVkID0gcHJldmVudENsb3NlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gcHJldmVudENsb3NlKGNsb3NlRXZlbnQpIHx8IGNsb3NlRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXByZXZlbnRlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3B1cFJlZmVyZW5jZS5jbG9zZShjbG9zZUV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cFN0YXRlTWFwLnJlbW92ZSh1aWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHBvcHVwUmVmZXJlbmNlLmNsb3NlZC5waXBlKHRha2UoMSkpLnN1YnNjcmliZSgoKSA9PiBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcG9wdXBSZWZlcmVuY2UuY2xvc2VkLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucG9wdXBTdGF0ZU1hcC5yZW1vdmUodWlkKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucG9wdXBTdGF0ZU1hcC5hZGQodWlkLCB7XG4gICAgICAgICAgICB1aWQsXG4gICAgICAgICAgICBwb3B1cFJlZjogcG9wdXBSZWZlcmVuY2UucG9wdXBSZWYsXG4gICAgICAgICAgICBzZXR0aW5nc1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zZXRFdmVudExpc3RlbmVycyh0aGlzLnBvcHVwU3RhdGVNYXAuZ2V0KHVpZCkpO1xuICAgICAgICByZXR1cm4gcG9wdXBSZWZlcmVuY2UucG9wdXBSZWY7XG4gICAgfVxuXG4gICAgcHVibGljIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgICAgICB0aGlzLnNlcnZpY2VEZXN0cm95JC5uZXh0KCk7XG4gICAgICAgIHRoaXMuc2VydmljZURlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRFdmVudExpc3RlbmVycyhzdGF0ZTogUG9wdXBTdGF0ZSk6IHZvaWQge1xuICAgICAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHN0YXRlLnNldHRpbmdzLmNsb3NlT25Fc2NhcGUgPz8gdHJ1ZSkge1xuICAgICAgICAgICAgICAgIGZyb21FdmVudDxLZXlib2FyZEV2ZW50Pihkb2N1bWVudCwgXCJrZXlkb3duXCIpXG4gICAgICAgICAgICAgICAgICAgIC5waXBlKHRha2VVbnRpbChzdGF0ZS5wb3B1cFJlZi5jbG9zZWQpKVxuICAgICAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKGV2ZW50ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiRXNjYXBlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9zZUV2ZW50ID0gbmV3IFBvcHVwQ2xvc2VFdmVudCh7IGV2ZW50LCB2aWE6IFBvcHVwQ2xvc2VTb3VyY2UuRXNjYXBlIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHByZXZlbnRlZCA9IHN0YXRlLnNldHRpbmdzLnByZXZlbnRDbG9zZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHN0YXRlLnNldHRpbmdzLnByZXZlbnRDbG9zZShjbG9zZUV2ZW50KSB8fCBjbG9zZUV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwcmV2ZW50ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wb3B1cFJlZi5jbG9zZShjbG9zZUV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBTdGF0ZU1hcC5yZW1vdmUoc3RhdGUudWlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19