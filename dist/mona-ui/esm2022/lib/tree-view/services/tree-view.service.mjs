import { EventEmitter, Injectable } from "@angular/core";
import { Dictionary, EnumerableSet, SortedSet } from "@mirei/ts-collections";
import * as i0 from "@angular/core";
export class TreeViewService {
    constructor() {
        this.checkableOptions = {
            checkChildren: true,
            mode: "multiple",
            checkParents: true,
            enabled: false
        };
        this.checkedKeys = new EnumerableSet();
        this.checkedKeysChange = new EventEmitter();
        this.disabledKeys = new EnumerableSet();
        this.expandedKeys = new EnumerableSet();
        this.expandedKeysChange = new EventEmitter();
        this.nodeDictionary = new Dictionary();
        this.nodeList = [];
        this.selectableOptions = {
            childrenOnly: false,
            enabled: false,
            mode: "single"
        };
        this.selectedKeys = new EnumerableSet();
        this.selectedKeysChange = new EventEmitter();
        this.viewNodeList = [];
    }
    static getNodeDisablerAction(disabler) {
        if (typeof disabler === "string") {
            return (item) => !!item?.[disabler] ?? false;
        }
        return disabler;
    }
    loadCheckedKeys(checkedKeys) {
        const checkedKeySet = new SortedSet(checkedKeys);
        for (const [uid, node] of this.nodeDictionary.entries()) {
            node.checked = checkedKeySet.contains(node.key);
        }
        for (const node of this.nodeDictionary.values()) {
            if (node.nodes.length > 0) {
                if (this.checkableOptions.checkChildren && checkedKeySet.contains(node.key)) {
                    node.check({ checked: true, checkChildren: true, checkParent: false });
                }
                if (this.checkableOptions.checkParents) {
                    node.indeterminate =
                        !node.checked && node.nodes.some(childNode => childNode.checked || childNode.indeterminate);
                }
            }
        }
    }
    loadDisabledKeys(disabledKeys) {
        const disabledKeySet = new SortedSet(disabledKeys);
        const disable = (node, disabled) => {
            node.disabled = disabled ?? disabledKeySet.contains(node.key);
            if (!node.disabled && disabled == null) {
                node.nodes.forEach(childNode => disable(childNode));
            }
            else if (!node.disabled) {
                node.nodes.forEach(childNode => disable(childNode, false));
            }
            else {
                node.nodes.forEach(childNode => disable(childNode, true));
            }
        };
        for (const node of this.nodeList) {
            disable(node);
        }
    }
    loadExpandedKeys(expandedKeys) {
        const expandedKeySet = new SortedSet(expandedKeys);
        for (const key of expandedKeySet) {
            const node = this.nodeDictionary.firstOrDefault(n => n.value.key === key)?.value;
            if (node) {
                node.expand(true);
            }
        }
    }
    loadSelectedKeys(selectedKeys) {
        const selectedKeySet = new SortedSet(selectedKeys);
        for (const key of selectedKeySet) {
            const node = this.nodeDictionary.firstOrDefault(n => n.value.key === key)?.value;
            if (node) {
                node.setSelected(true);
            }
        }
    }
    setCheckableOptions(options) {
        this.checkableOptions = { ...this.checkableOptions, ...options };
    }
    setSelectableOptions(options) {
        this.selectableOptions = { ...this.selectableOptions, ...options };
    }
    toggleNodeCheck(node, checked) {
        if (node.disabled) {
            return;
        }
        if (this.checkableOptions?.mode === "single") {
            this.uncheckAllNodes();
        }
        node.check({
            checked: checked ?? !node.checked,
            checkChildren: this.checkableOptions?.checkChildren,
            checkParent: this.checkableOptions?.checkParents
        });
        const checkedKeys = this.nodeDictionary
            .where(n => n.value.checked)
            .select(n => n.value.key)
            .toArray();
        this.checkedKeysChange.emit(checkedKeys);
    }
    toggleNodeExpand(node, expand) {
        if (node.nodes.length === 0) {
            return;
        }
        node.expand(expand ?? !node.expanded, false);
        const expandedKeys = this.nodeDictionary
            .where(n => n.value.expanded)
            .select(n => n.value.key)
            .toArray();
        this.expandedKeysChange.emit(expandedKeys);
    }
    toggleNodeSelection(node) {
        if (!this.selectableOptions.enabled) {
            return;
        }
        if (this.selectableOptions.childrenOnly && node.nodes.length > 0) {
            return;
        }
        if (node.disabled) {
            return;
        }
        if (node.selected) {
            node.setSelected(false);
            this.lastSelectedNode = undefined;
        }
        else {
            if (this.selectableOptions.mode === "single") {
                if (this.lastSelectedNode) {
                    this.lastSelectedNode.setSelected(false);
                }
            }
            node.setSelected(true);
            node.focused = true;
            this.lastSelectedNode = node;
        }
        const selectedKeys = this.nodeDictionary
            .where(n => n.value.selected)
            .select(n => n.value.key)
            .toArray();
        this.selectedKeysChange.emit(selectedKeys);
    }
    uncheckAllNodes() {
        this.nodeList.forEach(node => node.check({ checked: false, checkChildren: true, checkParent: true }));
    }
    updateNodeCheckStatus(node) {
        if (node.nodes.length > 0) {
            const allChecked = node.nodes.every(childNode => childNode.checked);
            const someChecked = node.nodes.some(childNode => childNode.checked);
            const someIndeterminate = node.nodes.some(childNode => childNode.indeterminate);
            node.checked = allChecked;
            node.indeterminate = someIndeterminate || (!allChecked && someChecked);
        }
        else {
            node.indeterminate = false;
        }
        let parent = node.parent;
        while (parent) {
            const allChecked = parent.nodes.every(childNode => childNode.checked);
            const someChecked = parent.nodes.some(childNode => childNode.checked);
            const someIndeterminate = parent.nodes.some(childNode => childNode.indeterminate);
            parent.checked = allChecked;
            parent.indeterminate = someIndeterminate || (!allChecked && someChecked);
            parent = parent.parent;
        }
        const checkedKeys = this.nodeDictionary
            .where(n => n.value.checked)
            .select(n => n.value.key)
            .toArray();
        this.checkedKeysChange.emit(checkedKeys);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: TreeViewService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: TreeViewService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: TreeViewService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS12aWV3LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9tb25hLXVpL3NyYy9saWIvdHJlZS12aWV3L3NlcnZpY2VzL3RyZWUtdmlldy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXpELE9BQU8sRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBRSxNQUFNLHVCQUF1QixDQUFDOztBQVE3RSxNQUFNLE9BQU8sZUFBZTtJQXdCeEI7UUF2Qk8scUJBQWdCLEdBQXFCO1lBQ3hDLGFBQWEsRUFBRSxJQUFJO1lBQ25CLElBQUksRUFBRSxVQUFVO1lBQ2hCLFlBQVksRUFBRSxJQUFJO1lBQ2xCLE9BQU8sRUFBRSxLQUFLO1NBQ2pCLENBQUM7UUFDSyxnQkFBVyxHQUEwQixJQUFJLGFBQWEsRUFBVSxDQUFDO1FBQ2pFLHNCQUFpQixHQUEyQixJQUFJLFlBQVksRUFBWSxDQUFDO1FBQ3pFLGlCQUFZLEdBQTBCLElBQUksYUFBYSxFQUFVLENBQUM7UUFDbEUsaUJBQVksR0FBMEIsSUFBSSxhQUFhLEVBQVUsQ0FBQztRQUNsRSx1QkFBa0IsR0FBMkIsSUFBSSxZQUFZLEVBQVksQ0FBQztRQUUxRSxtQkFBYyxHQUE2QixJQUFJLFVBQVUsRUFBZ0IsQ0FBQztRQUMxRSxhQUFRLEdBQVcsRUFBRSxDQUFDO1FBQ3RCLHNCQUFpQixHQUFzQjtZQUMxQyxZQUFZLEVBQUUsS0FBSztZQUNuQixPQUFPLEVBQUUsS0FBSztZQUNkLElBQUksRUFBRSxRQUFRO1NBQ2pCLENBQUM7UUFDSyxpQkFBWSxHQUEwQixJQUFJLGFBQWEsRUFBVSxDQUFDO1FBQ2xFLHVCQUFrQixHQUEyQixJQUFJLFlBQVksRUFBWSxDQUFDO1FBQzFFLGlCQUFZLEdBQVcsRUFBRSxDQUFDO0lBRVgsQ0FBQztJQUVo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Q0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDbEYsTUFBTSxDQUFDLE9BQU8sR0FBRyxVQUFVLENBQUM7WUFDNUIsTUFBTSxDQUFDLGFBQWEsR0FBRyxpQkFBaUIsSUFBSSxDQUFDLENBQUMsVUFBVSxJQUFJLFdBQVcsQ0FBQyxDQUFDO1lBQ3pFLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO1NBQzFCO1FBQ0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGNBQWM7YUFDbEMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUM7YUFDM0IsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7YUFDeEIsT0FBTyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzdDLENBQUM7OEdBekxRLGVBQWU7a0hBQWYsZUFBZTs7MkZBQWYsZUFBZTtrQkFEM0IsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV2ZW50RW1pdHRlciwgSW5qZWN0YWJsZSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBDaGVja2FibGVPcHRpb25zIH0gZnJvbSBcIi4uL2RhdGEvQ2hlY2thYmxlT3B0aW9uc1wiO1xuaW1wb3J0IHsgRGljdGlvbmFyeSwgRW51bWVyYWJsZVNldCwgU29ydGVkU2V0IH0gZnJvbSBcIkBtaXJlaS90cy1jb2xsZWN0aW9uc1wiO1xuaW1wb3J0IHsgTm9kZSB9IGZyb20gXCIuLi9kYXRhL05vZGVcIjtcbmltcG9ydCB7IFNlbGVjdGFibGVPcHRpb25zIH0gZnJvbSBcIi4uL2RhdGEvU2VsZWN0YWJsZU9wdGlvbnNcIjtcbmltcG9ydCB7IE5vZGVEaXNhYmxlciwgTm9kZURpc2FibGVyQWN0aW9uIH0gZnJvbSBcIi4uL2RhdGEvTm9kZURpc2FibGVyXCI7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSBcInJ4anNcIjtcbmltcG9ydCB7IENka0RyYWdTdGFydCB9IGZyb20gXCJAYW5ndWxhci9jZGsvZHJhZy1kcm9wXCI7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBUcmVlVmlld1NlcnZpY2Uge1xuICAgIHB1YmxpYyBjaGVja2FibGVPcHRpb25zOiBDaGVja2FibGVPcHRpb25zID0ge1xuICAgICAgICBjaGVja0NoaWxkcmVuOiB0cnVlLFxuICAgICAgICBtb2RlOiBcIm11bHRpcGxlXCIsXG4gICAgICAgIGNoZWNrUGFyZW50czogdHJ1ZSxcbiAgICAgICAgZW5hYmxlZDogZmFsc2VcbiAgICB9O1xuICAgIHB1YmxpYyBjaGVja2VkS2V5czogRW51bWVyYWJsZVNldDxzdHJpbmc+ID0gbmV3IEVudW1lcmFibGVTZXQ8c3RyaW5nPigpO1xuICAgIHB1YmxpYyBjaGVja2VkS2V5c0NoYW5nZTogRXZlbnRFbWl0dGVyPHN0cmluZ1tdPiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nW10+KCk7XG4gICAgcHVibGljIGRpc2FibGVkS2V5czogRW51bWVyYWJsZVNldDxzdHJpbmc+ID0gbmV3IEVudW1lcmFibGVTZXQ8c3RyaW5nPigpO1xuICAgIHB1YmxpYyBleHBhbmRlZEtleXM6IEVudW1lcmFibGVTZXQ8c3RyaW5nPiA9IG5ldyBFbnVtZXJhYmxlU2V0PHN0cmluZz4oKTtcbiAgICBwdWJsaWMgZXhwYW5kZWRLZXlzQ2hhbmdlOiBFdmVudEVtaXR0ZXI8c3RyaW5nW10+ID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmdbXT4oKTtcbiAgICBwdWJsaWMgbGFzdFNlbGVjdGVkTm9kZT86IE5vZGU7XG4gICAgcHVibGljIG5vZGVEaWN0aW9uYXJ5OiBEaWN0aW9uYXJ5PHN0cmluZywgTm9kZT4gPSBuZXcgRGljdGlvbmFyeTxzdHJpbmcsIE5vZGU+KCk7XG4gICAgcHVibGljIG5vZGVMaXN0OiBOb2RlW10gPSBbXTtcbiAgICBwdWJsaWMgc2VsZWN0YWJsZU9wdGlvbnM6IFNlbGVjdGFibGVPcHRpb25zID0ge1xuICAgICAgICBjaGlsZHJlbk9ubHk6IGZhbHNlLFxuICAgICAgICBlbmFibGVkOiBmYWxzZSxcbiAgICAgICAgbW9kZTogXCJzaW5nbGVcIlxuICAgIH07XG4gICAgcHVibGljIHNlbGVjdGVkS2V5czogRW51bWVyYWJsZVNldDxzdHJpbmc+ID0gbmV3IEVudW1lcmFibGVTZXQ8c3RyaW5nPigpO1xuICAgIHB1YmxpYyBzZWxlY3RlZEtleXNDaGFuZ2U6IEV2ZW50RW1pdHRlcjxzdHJpbmdbXT4gPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZ1tdPigpO1xuICAgIHB1YmxpYyB2aWV3Tm9kZUxpc3Q6IE5vZGVbXSA9IFtdO1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKCkge31cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0Tm9kZURpc2FibGVyQWN0aW9uKGRpc2FibGVyOiBOb2RlRGlzYWJsZXIpOiBOb2RlRGlzYWJsZXJBY3Rpb24ge1xuICAgICAgICBpZiAodHlwZW9mIGRpc2FibGVyID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICByZXR1cm4gKGl0ZW06IGFueSk6IGJvb2xlYW4gPT4gISFpdGVtPy5bZGlzYWJsZXJdID8/IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkaXNhYmxlcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgbG9hZENoZWNrZWRLZXlzKGNoZWNrZWRLZXlzOiBJdGVyYWJsZTxzdHJpbmc+KTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNoZWNrZWRLZXlTZXQgPSBuZXcgU29ydGVkU2V0KGNoZWNrZWRLZXlzKTtcbiAgICAgICAgZm9yIChjb25zdCBbdWlkLCBub2RlXSBvZiB0aGlzLm5vZGVEaWN0aW9uYXJ5LmVudHJpZXMoKSkge1xuICAgICAgICAgICAgbm9kZS5jaGVja2VkID0gY2hlY2tlZEtleVNldC5jb250YWlucyhub2RlLmtleSk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMubm9kZURpY3Rpb25hcnkudmFsdWVzKCkpIHtcbiAgICAgICAgICAgIGlmIChub2RlLm5vZGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGVja2FibGVPcHRpb25zLmNoZWNrQ2hpbGRyZW4gJiYgY2hlY2tlZEtleVNldC5jb250YWlucyhub2RlLmtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5jaGVjayh7IGNoZWNrZWQ6IHRydWUsIGNoZWNrQ2hpbGRyZW46IHRydWUsIGNoZWNrUGFyZW50OiBmYWxzZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hlY2thYmxlT3B0aW9ucy5jaGVja1BhcmVudHMpIHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5pbmRldGVybWluYXRlID1cbiAgICAgICAgICAgICAgICAgICAgICAgICFub2RlLmNoZWNrZWQgJiYgbm9kZS5ub2Rlcy5zb21lKGNoaWxkTm9kZSA9PiBjaGlsZE5vZGUuY2hlY2tlZCB8fCBjaGlsZE5vZGUuaW5kZXRlcm1pbmF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGxvYWREaXNhYmxlZEtleXMoZGlzYWJsZWRLZXlzOiBJdGVyYWJsZTxzdHJpbmc+KTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGRpc2FibGVkS2V5U2V0ID0gbmV3IFNvcnRlZFNldChkaXNhYmxlZEtleXMpO1xuICAgICAgICBjb25zdCBkaXNhYmxlID0gKG5vZGU6IE5vZGUsIGRpc2FibGVkPzogYm9vbGVhbik6IHZvaWQgPT4ge1xuICAgICAgICAgICAgbm9kZS5kaXNhYmxlZCA9IGRpc2FibGVkID8/IGRpc2FibGVkS2V5U2V0LmNvbnRhaW5zKG5vZGUua2V5KTtcbiAgICAgICAgICAgIGlmICghbm9kZS5kaXNhYmxlZCAmJiBkaXNhYmxlZCA9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgbm9kZS5ub2Rlcy5mb3JFYWNoKGNoaWxkTm9kZSA9PiBkaXNhYmxlKGNoaWxkTm9kZSkpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICghbm9kZS5kaXNhYmxlZCkge1xuICAgICAgICAgICAgICAgIG5vZGUubm9kZXMuZm9yRWFjaChjaGlsZE5vZGUgPT4gZGlzYWJsZShjaGlsZE5vZGUsIGZhbHNlKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5vZGUubm9kZXMuZm9yRWFjaChjaGlsZE5vZGUgPT4gZGlzYWJsZShjaGlsZE5vZGUsIHRydWUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMubm9kZUxpc3QpIHtcbiAgICAgICAgICAgIGRpc2FibGUobm9kZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgbG9hZEV4cGFuZGVkS2V5cyhleHBhbmRlZEtleXM6IEl0ZXJhYmxlPHN0cmluZz4pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZXhwYW5kZWRLZXlTZXQgPSBuZXcgU29ydGVkU2V0KGV4cGFuZGVkS2V5cyk7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IG9mIGV4cGFuZGVkS2V5U2V0KSB7XG4gICAgICAgICAgICBjb25zdCBub2RlID0gdGhpcy5ub2RlRGljdGlvbmFyeS5maXJzdE9yRGVmYXVsdChuID0+IG4udmFsdWUua2V5ID09PSBrZXkpPy52YWx1ZTtcbiAgICAgICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICAgICAgbm9kZS5leHBhbmQodHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgbG9hZFNlbGVjdGVkS2V5cyhzZWxlY3RlZEtleXM6IEl0ZXJhYmxlPHN0cmluZz4pOiB2b2lkIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRLZXlTZXQgPSBuZXcgU29ydGVkU2V0KHNlbGVjdGVkS2V5cyk7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IG9mIHNlbGVjdGVkS2V5U2V0KSB7XG4gICAgICAgICAgICBjb25zdCBub2RlID0gdGhpcy5ub2RlRGljdGlvbmFyeS5maXJzdE9yRGVmYXVsdChuID0+IG4udmFsdWUua2V5ID09PSBrZXkpPy52YWx1ZTtcbiAgICAgICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICAgICAgbm9kZS5zZXRTZWxlY3RlZCh0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzZXRDaGVja2FibGVPcHRpb25zKG9wdGlvbnM6IENoZWNrYWJsZU9wdGlvbnMpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jaGVja2FibGVPcHRpb25zID0geyAuLi50aGlzLmNoZWNrYWJsZU9wdGlvbnMsIC4uLm9wdGlvbnMgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0U2VsZWN0YWJsZU9wdGlvbnMob3B0aW9uczogU2VsZWN0YWJsZU9wdGlvbnMpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zZWxlY3RhYmxlT3B0aW9ucyA9IHsgLi4udGhpcy5zZWxlY3RhYmxlT3B0aW9ucywgLi4ub3B0aW9ucyB9O1xuICAgIH1cblxuICAgIHB1YmxpYyB0b2dnbGVOb2RlQ2hlY2sobm9kZTogTm9kZSwgY2hlY2tlZD86IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgaWYgKG5vZGUuZGlzYWJsZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5jaGVja2FibGVPcHRpb25zPy5tb2RlID09PSBcInNpbmdsZVwiKSB7XG4gICAgICAgICAgICB0aGlzLnVuY2hlY2tBbGxOb2RlcygpO1xuICAgICAgICB9XG4gICAgICAgIG5vZGUuY2hlY2soe1xuICAgICAgICAgICAgY2hlY2tlZDogY2hlY2tlZCA/PyAhbm9kZS5jaGVja2VkLFxuICAgICAgICAgICAgY2hlY2tDaGlsZHJlbjogdGhpcy5jaGVja2FibGVPcHRpb25zPy5jaGVja0NoaWxkcmVuLFxuICAgICAgICAgICAgY2hlY2tQYXJlbnQ6IHRoaXMuY2hlY2thYmxlT3B0aW9ucz8uY2hlY2tQYXJlbnRzXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBjaGVja2VkS2V5cyA9IHRoaXMubm9kZURpY3Rpb25hcnlcbiAgICAgICAgICAgIC53aGVyZShuID0+IG4udmFsdWUuY2hlY2tlZClcbiAgICAgICAgICAgIC5zZWxlY3QobiA9PiBuLnZhbHVlLmtleSlcbiAgICAgICAgICAgIC50b0FycmF5KCk7XG4gICAgICAgIHRoaXMuY2hlY2tlZEtleXNDaGFuZ2UuZW1pdChjaGVja2VkS2V5cyk7XG4gICAgfVxuXG4gICAgcHVibGljIHRvZ2dsZU5vZGVFeHBhbmQobm9kZTogTm9kZSwgZXhwYW5kPzogYm9vbGVhbik6IHZvaWQge1xuICAgICAgICBpZiAobm9kZS5ub2Rlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBub2RlLmV4cGFuZChleHBhbmQgPz8gIW5vZGUuZXhwYW5kZWQsIGZhbHNlKTtcbiAgICAgICAgY29uc3QgZXhwYW5kZWRLZXlzID0gdGhpcy5ub2RlRGljdGlvbmFyeVxuICAgICAgICAgICAgLndoZXJlKG4gPT4gbi52YWx1ZS5leHBhbmRlZClcbiAgICAgICAgICAgIC5zZWxlY3QobiA9PiBuLnZhbHVlLmtleSlcbiAgICAgICAgICAgIC50b0FycmF5KCk7XG4gICAgICAgIHRoaXMuZXhwYW5kZWRLZXlzQ2hhbmdlLmVtaXQoZXhwYW5kZWRLZXlzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdG9nZ2xlTm9kZVNlbGVjdGlvbihub2RlOiBOb2RlKTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy5zZWxlY3RhYmxlT3B0aW9ucy5lbmFibGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuc2VsZWN0YWJsZU9wdGlvbnMuY2hpbGRyZW5Pbmx5ICYmIG5vZGUubm9kZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChub2RlLmRpc2FibGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5vZGUuc2VsZWN0ZWQpIHtcbiAgICAgICAgICAgIG5vZGUuc2V0U2VsZWN0ZWQoZmFsc2UpO1xuICAgICAgICAgICAgdGhpcy5sYXN0U2VsZWN0ZWROb2RlID0gdW5kZWZpbmVkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0YWJsZU9wdGlvbnMubW9kZSA9PT0gXCJzaW5nbGVcIikge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmxhc3RTZWxlY3RlZE5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXN0U2VsZWN0ZWROb2RlLnNldFNlbGVjdGVkKGZhbHNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBub2RlLnNldFNlbGVjdGVkKHRydWUpO1xuICAgICAgICAgICAgbm9kZS5mb2N1c2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMubGFzdFNlbGVjdGVkTm9kZSA9IG5vZGU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRLZXlzID0gdGhpcy5ub2RlRGljdGlvbmFyeVxuICAgICAgICAgICAgLndoZXJlKG4gPT4gbi52YWx1ZS5zZWxlY3RlZClcbiAgICAgICAgICAgIC5zZWxlY3QobiA9PiBuLnZhbHVlLmtleSlcbiAgICAgICAgICAgIC50b0FycmF5KCk7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRLZXlzQ2hhbmdlLmVtaXQoc2VsZWN0ZWRLZXlzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdW5jaGVja0FsbE5vZGVzKCk6IHZvaWQge1xuICAgICAgICB0aGlzLm5vZGVMaXN0LmZvckVhY2gobm9kZSA9PiBub2RlLmNoZWNrKHsgY2hlY2tlZDogZmFsc2UsIGNoZWNrQ2hpbGRyZW46IHRydWUsIGNoZWNrUGFyZW50OiB0cnVlIH0pKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlTm9kZUNoZWNrU3RhdHVzKG5vZGU6IE5vZGUpOiB2b2lkIHtcbiAgICAgICAgaWYgKG5vZGUubm9kZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3QgYWxsQ2hlY2tlZCA9IG5vZGUubm9kZXMuZXZlcnkoY2hpbGROb2RlID0+IGNoaWxkTm9kZS5jaGVja2VkKTtcbiAgICAgICAgICAgIGNvbnN0IHNvbWVDaGVja2VkID0gbm9kZS5ub2Rlcy5zb21lKGNoaWxkTm9kZSA9PiBjaGlsZE5vZGUuY2hlY2tlZCk7XG4gICAgICAgICAgICBjb25zdCBzb21lSW5kZXRlcm1pbmF0ZSA9IG5vZGUubm9kZXMuc29tZShjaGlsZE5vZGUgPT4gY2hpbGROb2RlLmluZGV0ZXJtaW5hdGUpO1xuICAgICAgICAgICAgbm9kZS5jaGVja2VkID0gYWxsQ2hlY2tlZDtcbiAgICAgICAgICAgIG5vZGUuaW5kZXRlcm1pbmF0ZSA9IHNvbWVJbmRldGVybWluYXRlIHx8ICghYWxsQ2hlY2tlZCAmJiBzb21lQ2hlY2tlZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBub2RlLmluZGV0ZXJtaW5hdGUgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgcGFyZW50ID0gbm9kZS5wYXJlbnQ7XG4gICAgICAgIHdoaWxlIChwYXJlbnQpIHtcbiAgICAgICAgICAgIGNvbnN0IGFsbENoZWNrZWQgPSBwYXJlbnQubm9kZXMuZXZlcnkoY2hpbGROb2RlID0+IGNoaWxkTm9kZS5jaGVja2VkKTtcbiAgICAgICAgICAgIGNvbnN0IHNvbWVDaGVja2VkID0gcGFyZW50Lm5vZGVzLnNvbWUoY2hpbGROb2RlID0+IGNoaWxkTm9kZS5jaGVja2VkKTtcbiAgICAgICAgICAgIGNvbnN0IHNvbWVJbmRldGVybWluYXRlID0gcGFyZW50Lm5vZGVzLnNvbWUoY2hpbGROb2RlID0+IGNoaWxkTm9kZS5pbmRldGVybWluYXRlKTtcbiAgICAgICAgICAgIHBhcmVudC5jaGVja2VkID0gYWxsQ2hlY2tlZDtcbiAgICAgICAgICAgIHBhcmVudC5pbmRldGVybWluYXRlID0gc29tZUluZGV0ZXJtaW5hdGUgfHwgKCFhbGxDaGVja2VkICYmIHNvbWVDaGVja2VkKTtcbiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2hlY2tlZEtleXMgPSB0aGlzLm5vZGVEaWN0aW9uYXJ5XG4gICAgICAgICAgICAud2hlcmUobiA9PiBuLnZhbHVlLmNoZWNrZWQpXG4gICAgICAgICAgICAuc2VsZWN0KG4gPT4gbi52YWx1ZS5rZXkpXG4gICAgICAgICAgICAudG9BcnJheSgpO1xuICAgICAgICB0aGlzLmNoZWNrZWRLZXlzQ2hhbmdlLmVtaXQoY2hlY2tlZEtleXMpO1xuICAgIH1cbn1cbiJdfQ==