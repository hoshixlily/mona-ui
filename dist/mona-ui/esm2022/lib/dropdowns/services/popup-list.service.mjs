import { Injectable } from "@angular/core";
import { Enumerable, Group, List } from "@mirei/ts-collections";
import { PopupListItem } from "../data/PopupListItem";
import { Subject } from "rxjs";
import * as i0 from "@angular/core";
export class PopupListService {
    constructor() {
        this.scrollToListItem$ = new Subject();
        this.filterModeActive = false;
        this.sourceListData = new List();
        this.viewListData = new List();
    }
    static findFirstSelectedItem(items) {
        return items.selectMany(g => g.source).firstOrDefault(i => i.selected);
    }
    static findLastSelectedItem(items) {
        return items.selectMany(g => g.source).lastOrDefault(i => i.selected);
    }
    static findNextSelectableItem(items, item) {
        return (items
            .selectMany(g => g.source)
            .skipWhile(i => !i.dataEquals(item.data))
            .skip(1)
            .firstOrDefault(i => !i.disabled) ?? null);
    }
    static findPreviousSelectableItem(items, item) {
        return (items
            .selectMany(g => g.source)
            .reverse()
            .skipWhile(i => !i.dataEquals(item.data))
            .skip(1)
            .firstOrDefault(i => !i.disabled) ?? null);
    }
    static getItemDisablerAction(disabler) {
        if (typeof disabler === "string") {
            return (item) => !!item?.[disabler] ?? false;
        }
        return disabler;
    }
    static isFirstSelectableItem(items, item) {
        return PopupListService.findPreviousSelectableItem(items, item) === null;
    }
    static isLastSelectableItem(items, item) {
        return PopupListService.findNextSelectableItem(items, item) === null;
    }
    clearFilters() {
        this.viewListData = this.sourceListData.toList();
        this.viewListData.selectMany(g => g.source).forEach(i => (i.highlighted = false));
        this.filterModeActive = false;
    }
    filterItems(filter, selectionMode) {
        if (!filter) {
            this.clearFilters();
            return;
        }
        this.viewListData = this.sourceListData
            .select(g => {
            const filteredItems = g.source.where(i => i.text.toLowerCase().includes(filter.toLowerCase()));
            return new Group(g.key, filteredItems.toList());
        })
            .toList();
        if (selectionMode === "single") {
            const selectedItem = this.viewListData
                .selectMany(g => g.source)
                .where(i => i.selected)
                .firstOrDefault();
            if (selectedItem) {
                selectedItem.highlighted = true;
            }
            else {
                const firstItem = this.viewListData
                    .selectMany(g => g.source)
                    .where(i => !i.disabled)
                    .firstOrDefault();
                if (firstItem) {
                    firstItem.highlighted = true;
                }
            }
        }
        else {
            this.viewListData.selectMany(g => g.source).forEach(i => (i.highlighted = false));
            const firstItem = this.viewListData
                .selectMany(g => g.source)
                .where(i => !i.disabled)
                .firstOrDefault();
            if (firstItem) {
                firstItem.highlighted = true;
            }
        }
        this.filterModeActive = true;
    }
    getListItemsOfValues(values) {
        const popupListItems = [];
        values.forEach(v => {
            const item = this.sourceListData.selectMany(g => g.source).firstOrDefault(i => i.dataEquals(v));
            if (item) {
                popupListItems.push(item);
            }
        });
        return popupListItems;
    }
    initializeListData(params) {
        let listItems = new List();
        const createListItem = (item) => {
            return new PopupListItem({
                data: item,
                text: params.textField ? item[params.textField] : item,
                textField: params.textField,
                value: params.valueField ? item[params.valueField] : item,
                valueField: params.valueField
            });
        };
        if (params.groupField) {
            listItems = Enumerable.from(params.data)
                .groupBy(d => d[params.groupField])
                .select(g => new Group(g.key, g.select(d => createListItem(d)).toList()))
                .orderBy(g => g.key)
                .toList();
        }
        else {
            const items = Enumerable.from(params.data)
                .select(d => createListItem(d))
                .toList();
            listItems.add(new Group("", items));
        }
        const selectedItems = this.sourceListData
            .selectMany(g => g.source)
            .where(i => i.selected)
            .toList();
        this.sourceListData = listItems;
        this.viewListData = this.sourceListData.toList();
        this.sourceListData
            .selectMany(g => g.source)
            .forEach(i => {
            i.selected = selectedItems.any(s => s.dataEquals(i.data));
        });
        if (params.disabler) {
            const disablerAction = PopupListService.getItemDisablerAction(params.disabler);
            this.updateDisabledItems(disablerAction);
        }
        return listItems;
    }
    navigate(event, selectionMode) {
        const selectedItem = this.viewListData.selectMany(g => g.source).firstOrDefault(i => i.selected);
        const highlightedItem = this.viewListData.selectMany(g => g.source).firstOrDefault(i => i.highlighted);
        const firstItem = this.viewListData.selectMany(g => g.source).firstOrDefault(i => !i.disabled);
        const focusedItem = highlightedItem ?? selectedItem ?? null;
        let newItem = null;
        if (event.key === "ArrowDown") {
            event.preventDefault();
            if (focusedItem && PopupListService.isLastSelectableItem(this.viewListData, focusedItem)) {
                if (this.filterModeActive && focusedItem.highlighted && !focusedItem.selected) {
                    focusedItem.highlighted = false;
                    focusedItem.selected = true;
                }
                return focusedItem;
            }
            const nextItem = !focusedItem
                ? firstItem
                : PopupListService.findNextSelectableItem(this.viewListData, focusedItem);
            if (nextItem) {
                if (selectionMode === "single") {
                    if (this.filterModeActive) {
                        if (focusedItem && focusedItem.highlighted && !focusedItem.selected) {
                            focusedItem.highlighted = false;
                            focusedItem.selected = true;
                            newItem = focusedItem;
                            return newItem;
                        }
                        else {
                            if (focusedItem) {
                                focusedItem.selected = false;
                                focusedItem.highlighted = false;
                                nextItem.selected = true;
                            }
                        }
                    }
                    else {
                        if (focusedItem) {
                            if (focusedItem.highlighted && !focusedItem.selected) {
                                focusedItem.highlighted = false;
                                focusedItem.selected = true;
                                newItem = focusedItem;
                                return newItem;
                            }
                            else {
                                focusedItem.selected = false;
                                focusedItem.highlighted = false;
                            }
                        }
                        nextItem.selected = true;
                    }
                }
                else {
                    nextItem.highlighted = true;
                    if (focusedItem) {
                        focusedItem.highlighted = false;
                    }
                }
                newItem = nextItem;
            }
        }
        else if (event.key === "ArrowUp") {
            event.preventDefault();
            if (focusedItem) {
                if (PopupListService.isFirstSelectableItem(this.viewListData, focusedItem)) {
                    return focusedItem;
                }
                const previousItem = PopupListService.findPreviousSelectableItem(this.viewListData, focusedItem);
                if (previousItem) {
                    if (selectionMode === "single") {
                        if (this.filterModeActive) {
                            if (focusedItem.highlighted && !focusedItem.selected) {
                                focusedItem.highlighted = false;
                                focusedItem.selected = true;
                                newItem = focusedItem;
                                return newItem;
                            }
                            else {
                                focusedItem.selected = false;
                                focusedItem.highlighted = false;
                                previousItem.selected = true;
                            }
                        }
                        else {
                            if (focusedItem.highlighted && !focusedItem.selected) {
                                focusedItem.highlighted = false;
                                focusedItem.selected = true;
                                newItem = focusedItem;
                                return newItem;
                            }
                            else {
                                focusedItem.selected = false;
                                previousItem.selected = true;
                            }
                        }
                    }
                    else {
                        focusedItem.highlighted = false;
                        previousItem.highlighted = true;
                    }
                    newItem = previousItem;
                }
            }
        }
        return newItem;
    }
    selectItem(item, selectionMode) {
        if (selectionMode === "single") {
            this.viewListData.selectMany(g => g.source).forEach(i => (i.selected = false));
            item.selected = true;
        }
        else {
            item.selected = !item.selected;
        }
    }
    updateDisabledItems(disablerAction) {
        this.sourceListData.selectMany(g => g.source).forEach(i => (i.disabled = disablerAction(i.data)));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: PopupListService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: PopupListService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: PopupListService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wdXAtbGlzdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbW9uYS11aS9zcmMvbGliL2Ryb3Bkb3ducy9zZXJ2aWNlcy9wb3B1cC1saXN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFHdEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQzs7QUFHL0IsTUFBTSxPQUFPLGdCQUFnQjtJQU16QjtRQUxnQixzQkFBaUIsR0FBMkIsSUFBSSxPQUFPLEVBQWlCLENBQUM7UUFDbEYscUJBQWdCLEdBQVksS0FBSyxDQUFDO1FBQ2xDLG1CQUFjLEdBQXVDLElBQUksSUFBSSxFQUFnQyxDQUFDO1FBQzlGLGlCQUFZLEdBQXVDLElBQUksSUFBSSxFQUFnQyxDQUFDO0lBRTdFLENBQUM7SUFFaEIsTUFBTSxDQUFDLHFCQUFxQixDQUFDLEtBQXlDO1FBQ3pFLE9BQU8sS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDM0UsQ0FBQztJQUVNLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxLQUF5QztRQUN4RSxPQUFPLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzFFLENBQUM7SUFFTSxNQUFNLENBQUMsc0JBQXNCLENBQ2hDLEtBQXlDLEVBQ3pDLElBQW1CO1FBRW5CLE9BQU8sQ0FDSCxLQUFLO2FBQ0EsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQzthQUN6QixTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3hDLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDUCxjQUFjLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxJQUFJLENBQ2hELENBQUM7SUFDTixDQUFDO0lBRU0sTUFBTSxDQUFDLDBCQUEwQixDQUNwQyxLQUF5QyxFQUN6QyxJQUFtQjtRQUVuQixPQUFPLENBQ0gsS0FBSzthQUNBLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7YUFDekIsT0FBTyxFQUFFO2FBQ1QsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUN4QyxJQUFJLENBQUMsQ0FBQyxDQUFDO2FBQ1AsY0FBYyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxDQUNoRCxDQUFDO0lBQ04sQ0FBQztJQUVNLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxRQUFzQjtRQUN0RCxJQUFJLE9BQU8sUUFBUSxLQUFLLFFBQVEsRUFBRTtZQUM5QixPQUFPLENBQUMsSUFBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxDQUFDO1NBQ3JEO1FBQ0QsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztJQUVNLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxLQUF5QyxFQUFFLElBQW1CO1FBQzlGLE9BQU8sZ0JBQWdCLENBQUMsMEJBQTBCLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQztJQUM3RSxDQUFDO0lBRU0sTUFBTSxDQUFDLG9CQUFvQixDQUFDLEtBQXlDLEVBQUUsSUFBbUI7UUFDN0YsT0FBTyxnQkFBZ0IsQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDO0lBQ3pFLENBQUM7SUFFTSxZQUFZO1FBQ2YsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2pELElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ2xGLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7SUFDbEMsQ0FBQztJQUVNLFdBQVcsQ0FBQyxNQUFjLEVBQUUsYUFBNEI7UUFDM0QsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNULElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNwQixPQUFPO1NBQ1Y7UUFDRCxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxjQUFjO2FBQ2xDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUNSLE1BQU0sYUFBYSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUMvRixPQUFPLElBQUksS0FBSyxDQUF3QixDQUFDLENBQUMsR0FBRyxFQUFFLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQzNFLENBQUMsQ0FBQzthQUNELE1BQU0sRUFBRSxDQUFDO1FBQ2QsSUFBSSxhQUFhLEtBQUssUUFBUSxFQUFFO1lBQzVCLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZO2lCQUNqQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO2lCQUN6QixLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDO2lCQUN0QixjQUFjLEVBQUUsQ0FBQztZQUN0QixJQUFJLFlBQVksRUFBRTtnQkFDZCxZQUFZLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQzthQUNuQztpQkFBTTtnQkFDSCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWTtxQkFDOUIsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztxQkFDekIsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDO3FCQUN2QixjQUFjLEVBQUUsQ0FBQztnQkFDdEIsSUFBSSxTQUFTLEVBQUU7b0JBQ1gsU0FBUyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7aUJBQ2hDO2FBQ0o7U0FDSjthQUFNO1lBQ0gsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDbEYsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVk7aUJBQzlCLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7aUJBQ3pCLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztpQkFDdkIsY0FBYyxFQUFFLENBQUM7WUFDdEIsSUFBSSxTQUFTLEVBQUU7Z0JBQ1gsU0FBUyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7YUFDaEM7U0FDSjtRQUNELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7SUFDakMsQ0FBQztJQUVNLG9CQUFvQixDQUFDLE1BQWE7UUFDckMsTUFBTSxjQUFjLEdBQW9CLEVBQUUsQ0FBQztRQUMzQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ2YsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2hHLElBQUksSUFBSSxFQUFFO2dCQUNOLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDN0I7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sY0FBYyxDQUFDO0lBQzFCLENBQUM7SUFFTSxrQkFBa0IsQ0FBQyxNQU16QjtRQUNHLElBQUksU0FBUyxHQUF1QyxJQUFJLElBQUksRUFBZ0MsQ0FBQztRQUM3RixNQUFNLGNBQWMsR0FBRyxDQUFDLElBQVMsRUFBaUIsRUFBRTtZQUNoRCxPQUFPLElBQUksYUFBYSxDQUFDO2dCQUNyQixJQUFJLEVBQUUsSUFBSTtnQkFDVixJQUFJLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSTtnQkFDdEQsU0FBUyxFQUFFLE1BQU0sQ0FBQyxTQUFTO2dCQUMzQixLQUFLLEVBQUUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSTtnQkFDekQsVUFBVSxFQUFFLE1BQU0sQ0FBQyxVQUFVO2FBQ2hDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQztRQUNGLElBQUksTUFBTSxDQUFDLFVBQVUsRUFBRTtZQUNuQixTQUFTLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO2lCQUNuQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQW9CLENBQUMsQ0FBQztpQkFDNUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxLQUFLLENBQWMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztpQkFDckYsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztpQkFDbkIsTUFBTSxFQUFFLENBQUM7U0FDakI7YUFBTTtZQUNILE1BQU0sS0FBSyxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztpQkFDckMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUM5QixNQUFNLEVBQUUsQ0FBQztZQUNkLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLENBQWMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7U0FDcEQ7UUFFRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsY0FBYzthQUNwQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO2FBQ3pCLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7YUFDdEIsTUFBTSxFQUFFLENBQUM7UUFFZCxJQUFJLENBQUMsY0FBYyxHQUFHLFNBQVMsQ0FBQztRQUNoQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLENBQUM7UUFFakQsSUFBSSxDQUFDLGNBQWM7YUFDZCxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO2FBQ3pCLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUNULENBQUMsQ0FBQyxRQUFRLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDOUQsQ0FBQyxDQUFDLENBQUM7UUFFUCxJQUFJLE1BQU0sQ0FBQyxRQUFRLEVBQUU7WUFDakIsTUFBTSxjQUFjLEdBQUcsZ0JBQWdCLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQy9FLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxjQUFjLENBQUMsQ0FBQztTQUM1QztRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ3JCLENBQUM7SUFFTSxRQUFRLENBQUMsS0FBb0IsRUFBRSxhQUE0QjtRQUM5RCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDakcsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3ZHLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQy9GLE1BQU0sV0FBVyxHQUFHLGVBQWUsSUFBSSxZQUFZLElBQUksSUFBSSxDQUFDO1FBQzVELElBQUksT0FBTyxHQUF5QixJQUFJLENBQUM7UUFDekMsSUFBSSxLQUFLLENBQUMsR0FBRyxLQUFLLFdBQVcsRUFBRTtZQUMzQixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDdkIsSUFBSSxXQUFXLElBQUksZ0JBQWdCLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxXQUFXLENBQUMsRUFBRTtnQkFDdEYsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLElBQUksV0FBVyxDQUFDLFdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUU7b0JBQzNFLFdBQVcsQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO29CQUNoQyxXQUFXLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztpQkFDL0I7Z0JBQ0QsT0FBTyxXQUFXLENBQUM7YUFDdEI7WUFDRCxNQUFNLFFBQVEsR0FBRyxDQUFDLFdBQVc7Z0JBQ3pCLENBQUMsQ0FBQyxTQUFTO2dCQUNYLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQzlFLElBQUksUUFBUSxFQUFFO2dCQUNWLElBQUksYUFBYSxLQUFLLFFBQVEsRUFBRTtvQkFDNUIsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7d0JBQ3ZCLElBQUksV0FBVyxJQUFJLFdBQVcsQ0FBQyxXQUFXLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFOzRCQUNqRSxXQUFXLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQzs0QkFDaEMsV0FBVyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7NEJBQzVCLE9BQU8sR0FBRyxXQUFXLENBQUM7NEJBQ3RCLE9BQU8sT0FBTyxDQUFDO3lCQUNsQjs2QkFBTTs0QkFDSCxJQUFJLFdBQVcsRUFBRTtnQ0FDYixXQUFXLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztnQ0FDN0IsV0FBVyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7Z0NBQ2hDLFFBQVEsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDOzZCQUM1Qjt5QkFDSjtxQkFDSjt5QkFBTTt3QkFDSCxJQUFJLFdBQVcsRUFBRTs0QkFDYixJQUFJLFdBQVcsQ0FBQyxXQUFXLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFO2dDQUNsRCxXQUFXLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQztnQ0FDaEMsV0FBVyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7Z0NBQzVCLE9BQU8sR0FBRyxXQUFXLENBQUM7Z0NBQ3RCLE9BQU8sT0FBTyxDQUFDOzZCQUNsQjtpQ0FBTTtnQ0FDSCxXQUFXLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztnQ0FDN0IsV0FBVyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7NkJBQ25DO3lCQUNKO3dCQUNELFFBQVEsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO3FCQUM1QjtpQkFDSjtxQkFBTTtvQkFDSCxRQUFRLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztvQkFDNUIsSUFBSSxXQUFXLEVBQUU7d0JBQ2IsV0FBVyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7cUJBQ25DO2lCQUNKO2dCQUNELE9BQU8sR0FBRyxRQUFRLENBQUM7YUFDdEI7U0FDSjthQUFNLElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxTQUFTLEVBQUU7WUFDaEMsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3ZCLElBQUksV0FBVyxFQUFFO2dCQUNiLElBQUksZ0JBQWdCLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxXQUFXLENBQUMsRUFBRTtvQkFDeEUsT0FBTyxXQUFXLENBQUM7aUJBQ3RCO2dCQUNELE1BQU0sWUFBWSxHQUFHLGdCQUFnQixDQUFDLDBCQUEwQixDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUM7Z0JBQ2pHLElBQUksWUFBWSxFQUFFO29CQUNkLElBQUksYUFBYSxLQUFLLFFBQVEsRUFBRTt3QkFDNUIsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7NEJBQ3ZCLElBQUksV0FBVyxDQUFDLFdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUU7Z0NBQ2xELFdBQVcsQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO2dDQUNoQyxXQUFXLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztnQ0FDNUIsT0FBTyxHQUFHLFdBQVcsQ0FBQztnQ0FDdEIsT0FBTyxPQUFPLENBQUM7NkJBQ2xCO2lDQUFNO2dDQUNILFdBQVcsQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO2dDQUM3QixXQUFXLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQztnQ0FDaEMsWUFBWSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7NkJBQ2hDO3lCQUNKOzZCQUFNOzRCQUNILElBQUksV0FBVyxDQUFDLFdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUU7Z0NBQ2xELFdBQVcsQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO2dDQUNoQyxXQUFXLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztnQ0FDNUIsT0FBTyxHQUFHLFdBQVcsQ0FBQztnQ0FDdEIsT0FBTyxPQUFPLENBQUM7NkJBQ2xCO2lDQUFNO2dDQUNILFdBQVcsQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO2dDQUM3QixZQUFZLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQzs2QkFDaEM7eUJBQ0o7cUJBQ0o7eUJBQU07d0JBQ0gsV0FBVyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7d0JBQ2hDLFlBQVksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO3FCQUNuQztvQkFDRCxPQUFPLEdBQUcsWUFBWSxDQUFDO2lCQUMxQjthQUNKO1NBQ0o7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0lBRU0sVUFBVSxDQUFDLElBQW1CLEVBQUUsYUFBNEI7UUFDL0QsSUFBSSxhQUFhLEtBQUssUUFBUSxFQUFFO1lBQzVCLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQy9FLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1NBQ3hCO2FBQU07WUFDSCxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztTQUNsQztJQUNMLENBQUM7SUFFTyxtQkFBbUIsQ0FBQyxjQUFrQztRQUMxRCxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEdBQUcsY0FBYyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdEcsQ0FBQzs4R0FuUlEsZ0JBQWdCO2tIQUFoQixnQkFBZ0I7OzJGQUFoQixnQkFBZ0I7a0JBRDVCLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IEVudW1lcmFibGUsIEdyb3VwLCBMaXN0IH0gZnJvbSBcIkBtaXJlaS90cy1jb2xsZWN0aW9uc1wiO1xuaW1wb3J0IHsgUG9wdXBMaXN0SXRlbSB9IGZyb20gXCIuLi9kYXRhL1BvcHVwTGlzdEl0ZW1cIjtcbmltcG9ydCB7IFNlbGVjdGlvbk1vZGUgfSBmcm9tIFwiLi4vLi4vbW9kZWxzL1NlbGVjdGlvbk1vZGVcIjtcbmltcG9ydCB7IEl0ZW1EaXNhYmxlciwgSXRlbURpc2FibGVyQWN0aW9uIH0gZnJvbSBcIi4uL2RhdGEvSXRlbURpc2FibGVyXCI7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSBcInJ4anNcIjtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFBvcHVwTGlzdFNlcnZpY2Uge1xuICAgIHB1YmxpYyByZWFkb25seSBzY3JvbGxUb0xpc3RJdGVtJDogU3ViamVjdDxQb3B1cExpc3RJdGVtPiA9IG5ldyBTdWJqZWN0PFBvcHVwTGlzdEl0ZW0+KCk7XG4gICAgcHVibGljIGZpbHRlck1vZGVBY3RpdmU6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwdWJsaWMgc291cmNlTGlzdERhdGE6IExpc3Q8R3JvdXA8c3RyaW5nLCBQb3B1cExpc3RJdGVtPj4gPSBuZXcgTGlzdDxHcm91cDxzdHJpbmcsIFBvcHVwTGlzdEl0ZW0+PigpO1xuICAgIHB1YmxpYyB2aWV3TGlzdERhdGE6IExpc3Q8R3JvdXA8c3RyaW5nLCBQb3B1cExpc3RJdGVtPj4gPSBuZXcgTGlzdDxHcm91cDxzdHJpbmcsIFBvcHVwTGlzdEl0ZW0+PigpO1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKCkge31cblxuICAgIHB1YmxpYyBzdGF0aWMgZmluZEZpcnN0U2VsZWN0ZWRJdGVtKGl0ZW1zOiBMaXN0PEdyb3VwPHN0cmluZywgUG9wdXBMaXN0SXRlbT4+KTogUG9wdXBMaXN0SXRlbSB8IG51bGwge1xuICAgICAgICByZXR1cm4gaXRlbXMuc2VsZWN0TWFueShnID0+IGcuc291cmNlKS5maXJzdE9yRGVmYXVsdChpID0+IGkuc2VsZWN0ZWQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZmluZExhc3RTZWxlY3RlZEl0ZW0oaXRlbXM6IExpc3Q8R3JvdXA8c3RyaW5nLCBQb3B1cExpc3RJdGVtPj4pOiBQb3B1cExpc3RJdGVtIHwgbnVsbCB7XG4gICAgICAgIHJldHVybiBpdGVtcy5zZWxlY3RNYW55KGcgPT4gZy5zb3VyY2UpLmxhc3RPckRlZmF1bHQoaSA9PiBpLnNlbGVjdGVkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGZpbmROZXh0U2VsZWN0YWJsZUl0ZW0oXG4gICAgICAgIGl0ZW1zOiBMaXN0PEdyb3VwPHN0cmluZywgUG9wdXBMaXN0SXRlbT4+LFxuICAgICAgICBpdGVtOiBQb3B1cExpc3RJdGVtXG4gICAgKTogUG9wdXBMaXN0SXRlbSB8IG51bGwge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgaXRlbXNcbiAgICAgICAgICAgICAgICAuc2VsZWN0TWFueShnID0+IGcuc291cmNlKVxuICAgICAgICAgICAgICAgIC5za2lwV2hpbGUoaSA9PiAhaS5kYXRhRXF1YWxzKGl0ZW0uZGF0YSkpXG4gICAgICAgICAgICAgICAgLnNraXAoMSlcbiAgICAgICAgICAgICAgICAuZmlyc3RPckRlZmF1bHQoaSA9PiAhaS5kaXNhYmxlZCkgPz8gbnVsbFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZmluZFByZXZpb3VzU2VsZWN0YWJsZUl0ZW0oXG4gICAgICAgIGl0ZW1zOiBMaXN0PEdyb3VwPHN0cmluZywgUG9wdXBMaXN0SXRlbT4+LFxuICAgICAgICBpdGVtOiBQb3B1cExpc3RJdGVtXG4gICAgKTogUG9wdXBMaXN0SXRlbSB8IG51bGwge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgaXRlbXNcbiAgICAgICAgICAgICAgICAuc2VsZWN0TWFueShnID0+IGcuc291cmNlKVxuICAgICAgICAgICAgICAgIC5yZXZlcnNlKClcbiAgICAgICAgICAgICAgICAuc2tpcFdoaWxlKGkgPT4gIWkuZGF0YUVxdWFscyhpdGVtLmRhdGEpKVxuICAgICAgICAgICAgICAgIC5za2lwKDEpXG4gICAgICAgICAgICAgICAgLmZpcnN0T3JEZWZhdWx0KGkgPT4gIWkuZGlzYWJsZWQpID8/IG51bGxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldEl0ZW1EaXNhYmxlckFjdGlvbihkaXNhYmxlcjogSXRlbURpc2FibGVyKTogSXRlbURpc2FibGVyQWN0aW9uIHtcbiAgICAgICAgaWYgKHR5cGVvZiBkaXNhYmxlciA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgcmV0dXJuIChpdGVtOiBhbnkpID0+ICEhaXRlbT8uW2Rpc2FibGVyXSA/PyBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZGlzYWJsZXI7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBpc0ZpcnN0U2VsZWN0YWJsZUl0ZW0oaXRlbXM6IExpc3Q8R3JvdXA8c3RyaW5nLCBQb3B1cExpc3RJdGVtPj4sIGl0ZW06IFBvcHVwTGlzdEl0ZW0pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIFBvcHVwTGlzdFNlcnZpY2UuZmluZFByZXZpb3VzU2VsZWN0YWJsZUl0ZW0oaXRlbXMsIGl0ZW0pID09PSBudWxsO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgaXNMYXN0U2VsZWN0YWJsZUl0ZW0oaXRlbXM6IExpc3Q8R3JvdXA8c3RyaW5nLCBQb3B1cExpc3RJdGVtPj4sIGl0ZW06IFBvcHVwTGlzdEl0ZW0pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIFBvcHVwTGlzdFNlcnZpY2UuZmluZE5leHRTZWxlY3RhYmxlSXRlbShpdGVtcywgaXRlbSkgPT09IG51bGw7XG4gICAgfVxuXG4gICAgcHVibGljIGNsZWFyRmlsdGVycygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy52aWV3TGlzdERhdGEgPSB0aGlzLnNvdXJjZUxpc3REYXRhLnRvTGlzdCgpO1xuICAgICAgICB0aGlzLnZpZXdMaXN0RGF0YS5zZWxlY3RNYW55KGcgPT4gZy5zb3VyY2UpLmZvckVhY2goaSA9PiAoaS5oaWdobGlnaHRlZCA9IGZhbHNlKSk7XG4gICAgICAgIHRoaXMuZmlsdGVyTW9kZUFjdGl2ZSA9IGZhbHNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBmaWx0ZXJJdGVtcyhmaWx0ZXI6IHN0cmluZywgc2VsZWN0aW9uTW9kZTogU2VsZWN0aW9uTW9kZSk6IHZvaWQge1xuICAgICAgICBpZiAoIWZpbHRlcikge1xuICAgICAgICAgICAgdGhpcy5jbGVhckZpbHRlcnMoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnZpZXdMaXN0RGF0YSA9IHRoaXMuc291cmNlTGlzdERhdGFcbiAgICAgICAgICAgIC5zZWxlY3QoZyA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyZWRJdGVtcyA9IGcuc291cmNlLndoZXJlKGkgPT4gaS50ZXh0LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoZmlsdGVyLnRvTG93ZXJDYXNlKCkpKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEdyb3VwPHN0cmluZywgUG9wdXBMaXN0SXRlbT4oZy5rZXksIGZpbHRlcmVkSXRlbXMudG9MaXN0KCkpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50b0xpc3QoKTtcbiAgICAgICAgaWYgKHNlbGVjdGlvbk1vZGUgPT09IFwic2luZ2xlXCIpIHtcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkSXRlbSA9IHRoaXMudmlld0xpc3REYXRhXG4gICAgICAgICAgICAgICAgLnNlbGVjdE1hbnkoZyA9PiBnLnNvdXJjZSlcbiAgICAgICAgICAgICAgICAud2hlcmUoaSA9PiBpLnNlbGVjdGVkKVxuICAgICAgICAgICAgICAgIC5maXJzdE9yRGVmYXVsdCgpO1xuICAgICAgICAgICAgaWYgKHNlbGVjdGVkSXRlbSkge1xuICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbS5oaWdobGlnaHRlZCA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IGZpcnN0SXRlbSA9IHRoaXMudmlld0xpc3REYXRhXG4gICAgICAgICAgICAgICAgICAgIC5zZWxlY3RNYW55KGcgPT4gZy5zb3VyY2UpXG4gICAgICAgICAgICAgICAgICAgIC53aGVyZShpID0+ICFpLmRpc2FibGVkKVxuICAgICAgICAgICAgICAgICAgICAuZmlyc3RPckRlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBpZiAoZmlyc3RJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpcnN0SXRlbS5oaWdobGlnaHRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy52aWV3TGlzdERhdGEuc2VsZWN0TWFueShnID0+IGcuc291cmNlKS5mb3JFYWNoKGkgPT4gKGkuaGlnaGxpZ2h0ZWQgPSBmYWxzZSkpO1xuICAgICAgICAgICAgY29uc3QgZmlyc3RJdGVtID0gdGhpcy52aWV3TGlzdERhdGFcbiAgICAgICAgICAgICAgICAuc2VsZWN0TWFueShnID0+IGcuc291cmNlKVxuICAgICAgICAgICAgICAgIC53aGVyZShpID0+ICFpLmRpc2FibGVkKVxuICAgICAgICAgICAgICAgIC5maXJzdE9yRGVmYXVsdCgpO1xuICAgICAgICAgICAgaWYgKGZpcnN0SXRlbSkge1xuICAgICAgICAgICAgICAgIGZpcnN0SXRlbS5oaWdobGlnaHRlZCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5maWx0ZXJNb2RlQWN0aXZlID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0TGlzdEl0ZW1zT2ZWYWx1ZXModmFsdWVzOiBhbnlbXSk6IFBvcHVwTGlzdEl0ZW1bXSB7XG4gICAgICAgIGNvbnN0IHBvcHVwTGlzdEl0ZW1zOiBQb3B1cExpc3RJdGVtW10gPSBbXTtcbiAgICAgICAgdmFsdWVzLmZvckVhY2godiA9PiB7XG4gICAgICAgICAgICBjb25zdCBpdGVtID0gdGhpcy5zb3VyY2VMaXN0RGF0YS5zZWxlY3RNYW55KGcgPT4gZy5zb3VyY2UpLmZpcnN0T3JEZWZhdWx0KGkgPT4gaS5kYXRhRXF1YWxzKHYpKTtcbiAgICAgICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgICAgICAgcG9wdXBMaXN0SXRlbXMucHVzaChpdGVtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBwb3B1cExpc3RJdGVtcztcbiAgICB9XG5cbiAgICBwdWJsaWMgaW5pdGlhbGl6ZUxpc3REYXRhKHBhcmFtczoge1xuICAgICAgICBkYXRhOiBJdGVyYWJsZTxhbnk+O1xuICAgICAgICBkaXNhYmxlcj86IEl0ZW1EaXNhYmxlcjtcbiAgICAgICAgdGV4dEZpZWxkPzogc3RyaW5nO1xuICAgICAgICB2YWx1ZUZpZWxkPzogc3RyaW5nO1xuICAgICAgICBncm91cEZpZWxkPzogc3RyaW5nO1xuICAgIH0pOiBMaXN0PEdyb3VwPHN0cmluZywgYW55Pj4ge1xuICAgICAgICBsZXQgbGlzdEl0ZW1zOiBMaXN0PEdyb3VwPHN0cmluZywgUG9wdXBMaXN0SXRlbT4+ID0gbmV3IExpc3Q8R3JvdXA8c3RyaW5nLCBQb3B1cExpc3RJdGVtPj4oKTtcbiAgICAgICAgY29uc3QgY3JlYXRlTGlzdEl0ZW0gPSAoaXRlbTogYW55KTogUG9wdXBMaXN0SXRlbSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFBvcHVwTGlzdEl0ZW0oe1xuICAgICAgICAgICAgICAgIGRhdGE6IGl0ZW0sXG4gICAgICAgICAgICAgICAgdGV4dDogcGFyYW1zLnRleHRGaWVsZCA/IGl0ZW1bcGFyYW1zLnRleHRGaWVsZF0gOiBpdGVtLFxuICAgICAgICAgICAgICAgIHRleHRGaWVsZDogcGFyYW1zLnRleHRGaWVsZCxcbiAgICAgICAgICAgICAgICB2YWx1ZTogcGFyYW1zLnZhbHVlRmllbGQgPyBpdGVtW3BhcmFtcy52YWx1ZUZpZWxkXSA6IGl0ZW0sXG4gICAgICAgICAgICAgICAgdmFsdWVGaWVsZDogcGFyYW1zLnZhbHVlRmllbGRcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICBpZiAocGFyYW1zLmdyb3VwRmllbGQpIHtcbiAgICAgICAgICAgIGxpc3RJdGVtcyA9IEVudW1lcmFibGUuZnJvbShwYXJhbXMuZGF0YSlcbiAgICAgICAgICAgICAgICAuZ3JvdXBCeShkID0+IGRbcGFyYW1zLmdyb3VwRmllbGQgYXMgc3RyaW5nXSlcbiAgICAgICAgICAgICAgICAuc2VsZWN0KGcgPT4gbmV3IEdyb3VwPHN0cmluZywgYW55PihnLmtleSwgZy5zZWxlY3QoZCA9PiBjcmVhdGVMaXN0SXRlbShkKSkudG9MaXN0KCkpKVxuICAgICAgICAgICAgICAgIC5vcmRlckJ5KGcgPT4gZy5rZXkpXG4gICAgICAgICAgICAgICAgLnRvTGlzdCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgaXRlbXMgPSBFbnVtZXJhYmxlLmZyb20ocGFyYW1zLmRhdGEpXG4gICAgICAgICAgICAgICAgLnNlbGVjdChkID0+IGNyZWF0ZUxpc3RJdGVtKGQpKVxuICAgICAgICAgICAgICAgIC50b0xpc3QoKTtcbiAgICAgICAgICAgIGxpc3RJdGVtcy5hZGQobmV3IEdyb3VwPHN0cmluZywgYW55PihcIlwiLCBpdGVtcykpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRJdGVtcyA9IHRoaXMuc291cmNlTGlzdERhdGFcbiAgICAgICAgICAgIC5zZWxlY3RNYW55KGcgPT4gZy5zb3VyY2UpXG4gICAgICAgICAgICAud2hlcmUoaSA9PiBpLnNlbGVjdGVkKVxuICAgICAgICAgICAgLnRvTGlzdCgpO1xuXG4gICAgICAgIHRoaXMuc291cmNlTGlzdERhdGEgPSBsaXN0SXRlbXM7XG4gICAgICAgIHRoaXMudmlld0xpc3REYXRhID0gdGhpcy5zb3VyY2VMaXN0RGF0YS50b0xpc3QoKTtcblxuICAgICAgICB0aGlzLnNvdXJjZUxpc3REYXRhXG4gICAgICAgICAgICAuc2VsZWN0TWFueShnID0+IGcuc291cmNlKVxuICAgICAgICAgICAgLmZvckVhY2goaSA9PiB7XG4gICAgICAgICAgICAgICAgaS5zZWxlY3RlZCA9IHNlbGVjdGVkSXRlbXMuYW55KHMgPT4gcy5kYXRhRXF1YWxzKGkuZGF0YSkpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHBhcmFtcy5kaXNhYmxlcikge1xuICAgICAgICAgICAgY29uc3QgZGlzYWJsZXJBY3Rpb24gPSBQb3B1cExpc3RTZXJ2aWNlLmdldEl0ZW1EaXNhYmxlckFjdGlvbihwYXJhbXMuZGlzYWJsZXIpO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVEaXNhYmxlZEl0ZW1zKGRpc2FibGVyQWN0aW9uKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBsaXN0SXRlbXM7XG4gICAgfVxuXG4gICAgcHVibGljIG5hdmlnYXRlKGV2ZW50OiBLZXlib2FyZEV2ZW50LCBzZWxlY3Rpb25Nb2RlOiBTZWxlY3Rpb25Nb2RlKTogUG9wdXBMaXN0SXRlbSB8IG51bGwge1xuICAgICAgICBjb25zdCBzZWxlY3RlZEl0ZW0gPSB0aGlzLnZpZXdMaXN0RGF0YS5zZWxlY3RNYW55KGcgPT4gZy5zb3VyY2UpLmZpcnN0T3JEZWZhdWx0KGkgPT4gaS5zZWxlY3RlZCk7XG4gICAgICAgIGNvbnN0IGhpZ2hsaWdodGVkSXRlbSA9IHRoaXMudmlld0xpc3REYXRhLnNlbGVjdE1hbnkoZyA9PiBnLnNvdXJjZSkuZmlyc3RPckRlZmF1bHQoaSA9PiBpLmhpZ2hsaWdodGVkKTtcbiAgICAgICAgY29uc3QgZmlyc3RJdGVtID0gdGhpcy52aWV3TGlzdERhdGEuc2VsZWN0TWFueShnID0+IGcuc291cmNlKS5maXJzdE9yRGVmYXVsdChpID0+ICFpLmRpc2FibGVkKTtcbiAgICAgICAgY29uc3QgZm9jdXNlZEl0ZW0gPSBoaWdobGlnaHRlZEl0ZW0gPz8gc2VsZWN0ZWRJdGVtID8/IG51bGw7XG4gICAgICAgIGxldCBuZXdJdGVtOiBQb3B1cExpc3RJdGVtIHwgbnVsbCA9IG51bGw7XG4gICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiQXJyb3dEb3duXCIpIHtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBpZiAoZm9jdXNlZEl0ZW0gJiYgUG9wdXBMaXN0U2VydmljZS5pc0xhc3RTZWxlY3RhYmxlSXRlbSh0aGlzLnZpZXdMaXN0RGF0YSwgZm9jdXNlZEl0ZW0pKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZmlsdGVyTW9kZUFjdGl2ZSAmJiBmb2N1c2VkSXRlbS5oaWdobGlnaHRlZCAmJiAhZm9jdXNlZEl0ZW0uc2VsZWN0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9jdXNlZEl0ZW0uaGlnaGxpZ2h0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgZm9jdXNlZEl0ZW0uc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZm9jdXNlZEl0ZW07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBuZXh0SXRlbSA9ICFmb2N1c2VkSXRlbVxuICAgICAgICAgICAgICAgID8gZmlyc3RJdGVtXG4gICAgICAgICAgICAgICAgOiBQb3B1cExpc3RTZXJ2aWNlLmZpbmROZXh0U2VsZWN0YWJsZUl0ZW0odGhpcy52aWV3TGlzdERhdGEsIGZvY3VzZWRJdGVtKTtcbiAgICAgICAgICAgIGlmIChuZXh0SXRlbSkge1xuICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rpb25Nb2RlID09PSBcInNpbmdsZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZpbHRlck1vZGVBY3RpdmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb2N1c2VkSXRlbSAmJiBmb2N1c2VkSXRlbS5oaWdobGlnaHRlZCAmJiAhZm9jdXNlZEl0ZW0uc2VsZWN0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkSXRlbS5oaWdobGlnaHRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvY3VzZWRJdGVtLnNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdJdGVtID0gZm9jdXNlZEl0ZW07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ld0l0ZW07XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb2N1c2VkSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkSXRlbS5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkSXRlbS5oaWdobGlnaHRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0SXRlbS5zZWxlY3RlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzZWRJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzZWRJdGVtLmhpZ2hsaWdodGVkICYmICFmb2N1c2VkSXRlbS5zZWxlY3RlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkSXRlbS5oaWdobGlnaHRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkSXRlbS5zZWxlY3RlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0l0ZW0gPSBmb2N1c2VkSXRlbTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ld0l0ZW07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9jdXNlZEl0ZW0uc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9jdXNlZEl0ZW0uaGlnaGxpZ2h0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXh0SXRlbS5zZWxlY3RlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuZXh0SXRlbS5oaWdobGlnaHRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmb2N1c2VkSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9jdXNlZEl0ZW0uaGlnaGxpZ2h0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBuZXdJdGVtID0gbmV4dEl0ZW07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnQua2V5ID09PSBcIkFycm93VXBcIikge1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIGlmIChmb2N1c2VkSXRlbSkge1xuICAgICAgICAgICAgICAgIGlmIChQb3B1cExpc3RTZXJ2aWNlLmlzRmlyc3RTZWxlY3RhYmxlSXRlbSh0aGlzLnZpZXdMaXN0RGF0YSwgZm9jdXNlZEl0ZW0pKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmb2N1c2VkSXRlbTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgcHJldmlvdXNJdGVtID0gUG9wdXBMaXN0U2VydmljZS5maW5kUHJldmlvdXNTZWxlY3RhYmxlSXRlbSh0aGlzLnZpZXdMaXN0RGF0YSwgZm9jdXNlZEl0ZW0pO1xuICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0l0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdGlvbk1vZGUgPT09IFwic2luZ2xlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZpbHRlck1vZGVBY3RpdmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9jdXNlZEl0ZW0uaGlnaGxpZ2h0ZWQgJiYgIWZvY3VzZWRJdGVtLnNlbGVjdGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvY3VzZWRJdGVtLmhpZ2hsaWdodGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvY3VzZWRJdGVtLnNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3SXRlbSA9IGZvY3VzZWRJdGVtO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3SXRlbTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkSXRlbS5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkSXRlbS5oaWdobGlnaHRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0l0ZW0uc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzZWRJdGVtLmhpZ2hsaWdodGVkICYmICFmb2N1c2VkSXRlbS5zZWxlY3RlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkSXRlbS5oaWdobGlnaHRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkSXRlbS5zZWxlY3RlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0l0ZW0gPSBmb2N1c2VkSXRlbTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ld0l0ZW07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9jdXNlZEl0ZW0uc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNJdGVtLnNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkSXRlbS5oaWdobGlnaHRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNJdGVtLmhpZ2hsaWdodGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBuZXdJdGVtID0gcHJldmlvdXNJdGVtO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3SXRlbTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2VsZWN0SXRlbShpdGVtOiBQb3B1cExpc3RJdGVtLCBzZWxlY3Rpb25Nb2RlOiBTZWxlY3Rpb25Nb2RlKTogdm9pZCB7XG4gICAgICAgIGlmIChzZWxlY3Rpb25Nb2RlID09PSBcInNpbmdsZVwiKSB7XG4gICAgICAgICAgICB0aGlzLnZpZXdMaXN0RGF0YS5zZWxlY3RNYW55KGcgPT4gZy5zb3VyY2UpLmZvckVhY2goaSA9PiAoaS5zZWxlY3RlZCA9IGZhbHNlKSk7XG4gICAgICAgICAgICBpdGVtLnNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGl0ZW0uc2VsZWN0ZWQgPSAhaXRlbS5zZWxlY3RlZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlRGlzYWJsZWRJdGVtcyhkaXNhYmxlckFjdGlvbjogSXRlbURpc2FibGVyQWN0aW9uKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc291cmNlTGlzdERhdGEuc2VsZWN0TWFueShnID0+IGcuc291cmNlKS5mb3JFYWNoKGkgPT4gKGkuZGlzYWJsZWQgPSBkaXNhYmxlckFjdGlvbihpLmRhdGEpKSk7XG4gICAgfVxufVxuIl19