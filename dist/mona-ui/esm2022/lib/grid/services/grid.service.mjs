import { EventEmitter, Injectable } from "@angular/core";
import { Dictionary, Enumerable, EnumerableSet } from "@mirei/ts-collections";
import { Row } from "../models/Row";
import { Subject } from "rxjs";
import * as i0 from "@angular/core";
export class GridService {
    constructor() {
        this.cellEdit$ = new Subject();
        this.selectedRowsChange$ = new Subject();
        this.appliedFilters = new Dictionary();
        this.appliedSorts = new Dictionary();
        this.columns = [];
        this.editableOptions = { enabled: false };
        this.filterLoad$ = new Subject();
        this.groupColumns = [];
        this.gridGroupExpandState = new Dictionary();
        this.isInEditMode = false;
        this.pageState = { page: 1, skip: 0, take: 10 };
        this.rows = [];
        this.selectedKeys = new EnumerableSet();
        this.selectionKeyField = ""; // set by GridSelectableDirective
        this.selectableOptions = {
            enabled: false,
            mode: "single"
        };
        this.selectedKeysChange = new EventEmitter();
        this.selectedRows = [];
        this.sortLoad$ = new Subject();
        this.sortableOptions = {
            enabled: false,
            mode: "single",
            allowUnsort: false,
            showIndices: true
        };
    }
    loadFilters(filters) {
        const newAppliedFilters = new Dictionary();
        for (const filter of filters) {
            const filter1 = filter.filters[0];
            const filter2 = filter.filters[1];
            const column = this.columns.find(c => c.field === filter1.field);
            if (column != null) {
                newAppliedFilters.add(column.field, {
                    filter: filter,
                    filterMenuValue: {
                        value1: filter1 && "value" in filter1 ? filter1.value : undefined,
                        value2: filter2 && "value" in filter2 ? filter2.value : undefined,
                        operator1: filter1 ? filter1.operator : undefined,
                        operator2: filter2 ? filter2.operator : undefined,
                        logic: filter.logic || "and"
                    }
                });
            }
        }
        this.columns.forEach(c => (c.filtered = newAppliedFilters.containsKey(c.field)));
        this.appliedFilters = newAppliedFilters;
        this.filterLoad$.next();
    }
    loadSelectedKeys(selectedKeys) {
        this.selectedRows = [];
        this.selectedKeys = new EnumerableSet(selectedKeys);
        for (const row of this.rows) {
            const fieldData = this.selectionKeyField ? row.data[this.selectionKeyField] : row.data;
            if (fieldData == null) {
                continue;
            }
            row.selected = this.selectedKeys.contains(fieldData);
            if (row.selected) {
                this.selectedRows = [...this.selectedRows, row];
            }
        }
    }
    loadSorts(sorts) {
        const newAppliedSorts = new Dictionary();
        for (const [index, sort] of sorts.entries()) {
            const column = this.columns.find(c => c.field === sort.field);
            if (column != null) {
                newAppliedSorts.add(column.field, {
                    sort: sort
                });
                column.sortIndex = index + 1;
                column.sortDirection = sort.dir;
            }
        }
        this.appliedSorts = newAppliedSorts;
        this.sortLoad$.next();
    }
    setEditableOptions(options) {
        this.editableOptions = { ...this.editableOptions, ...options };
    }
    setRows(value) {
        this.rows = Enumerable.from(value)
            .select(r => new Row(r))
            .toArray();
    }
    setSelectableOptions(options) {
        this.selectableOptions = { ...this.selectableOptions, ...options };
    }
    setSortableOptions(options) {
        this.sortableOptions = { ...this.sortableOptions, ...options };
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: GridService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: GridService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: GridService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbW9uYS11aS9zcmMvbGliL2dyaWQvc2VydmljZXMvZ3JpZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXpELE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRzlFLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFcEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQzs7QUFRL0IsTUFBTSxPQUFPLFdBQVc7SUFpQ3BCO1FBaENnQixjQUFTLEdBQTJCLElBQUksT0FBTyxFQUFpQixDQUFDO1FBQ2pFLHdCQUFtQixHQUFtQixJQUFJLE9BQU8sRUFBUyxDQUFDO1FBQ3BFLG1CQUFjLEdBQTBDLElBQUksVUFBVSxFQUE2QixDQUFDO1FBQ3BHLGlCQUFZLEdBQXdDLElBQUksVUFBVSxFQUEyQixDQUFDO1FBQzlGLFlBQU8sR0FBYSxFQUFFLENBQUM7UUFDdkIsb0JBQWUsR0FBb0IsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUM7UUFDdEQsZ0JBQVcsR0FBa0IsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUVqRCxpQkFBWSxHQUFhLEVBQUUsQ0FBQztRQUM1Qix5QkFBb0IsR0FBb0QsSUFBSSxVQUFVLEVBRzFGLENBQUM7UUFDRyxpQkFBWSxHQUFZLEtBQUssQ0FBQztRQUM5QixjQUFTLEdBQWlELEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQztRQUN6RixTQUFJLEdBQVUsRUFBRSxDQUFDO1FBQ2pCLGlCQUFZLEdBQTJCLElBQUksYUFBYSxFQUFXLENBQUM7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Q0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3ZCLE9BQU8sRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFFTSxvQkFBb0IsQ0FBQyxPQUEwQjtRQUNsRCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLE9BQU8sRUFBRSxDQUFDO0lBQ3ZFLENBQUM7SUFFTSxrQkFBa0IsQ0FBQyxPQUF3QjtRQUM5QyxJQUFJLENBQUMsZUFBZSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLEdBQUcsT0FBTyxFQUFFLENBQUM7SUFDbkUsQ0FBQzs4R0ExR1EsV0FBVztrSEFBWCxXQUFXOzsyRkFBWCxXQUFXO2tCQUR2QixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IENvbHVtbiB9IGZyb20gXCIuLi9tb2RlbHMvQ29sdW1uXCI7XG5pbXBvcnQgeyBEaWN0aW9uYXJ5LCBFbnVtZXJhYmxlLCBFbnVtZXJhYmxlU2V0IH0gZnJvbSBcIkBtaXJlaS90cy1jb2xsZWN0aW9uc1wiO1xuaW1wb3J0IHsgQ29sdW1uRmlsdGVyU3RhdGUgfSBmcm9tIFwiLi4vbW9kZWxzL0NvbHVtbkZpbHRlclN0YXRlXCI7XG5pbXBvcnQgeyBDb2x1bW5Tb3J0U3RhdGUgfSBmcm9tIFwiLi4vbW9kZWxzL0NvbHVtblNvcnRTdGF0ZVwiO1xuaW1wb3J0IHsgUm93IH0gZnJvbSBcIi4uL21vZGVscy9Sb3dcIjtcbmltcG9ydCB7IFNlbGVjdGFibGVPcHRpb25zIH0gZnJvbSBcIi4uL21vZGVscy9TZWxlY3RhYmxlT3B0aW9uc1wiO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyBDb21wb3NpdGVGaWx0ZXJEZXNjcmlwdG9yLCBGaWx0ZXJEZXNjcmlwdG9yIH0gZnJvbSBcIi4uLy4uL3F1ZXJ5L2ZpbHRlci9GaWx0ZXJEZXNjcmlwdG9yXCI7XG5pbXBvcnQgeyBTb3J0YWJsZU9wdGlvbnMgfSBmcm9tIFwiLi4vbW9kZWxzL1NvcnRhYmxlT3B0aW9uc1wiO1xuaW1wb3J0IHsgU29ydERlc2NyaXB0b3IgfSBmcm9tIFwiLi4vLi4vcXVlcnkvc29ydC9Tb3J0RGVzY3JpcHRvclwiO1xuaW1wb3J0IHsgQ2VsbEVkaXRFdmVudCB9IGZyb20gXCIuLi9tb2RlbHMvQ2VsbEVkaXRFdmVudFwiO1xuaW1wb3J0IHsgRWRpdGFibGVPcHRpb25zIH0gZnJvbSBcIi4uL21vZGVscy9FZGl0YWJsZU9wdGlvbnNcIjtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEdyaWRTZXJ2aWNlIHtcbiAgICBwdWJsaWMgcmVhZG9ubHkgY2VsbEVkaXQkOiBTdWJqZWN0PENlbGxFZGl0RXZlbnQ+ID0gbmV3IFN1YmplY3Q8Q2VsbEVkaXRFdmVudD4oKTtcbiAgICBwdWJsaWMgcmVhZG9ubHkgc2VsZWN0ZWRSb3dzQ2hhbmdlJDogU3ViamVjdDxSb3dbXT4gPSBuZXcgU3ViamVjdDxSb3dbXT4oKTtcbiAgICBwdWJsaWMgYXBwbGllZEZpbHRlcnM6IERpY3Rpb25hcnk8c3RyaW5nLCBDb2x1bW5GaWx0ZXJTdGF0ZT4gPSBuZXcgRGljdGlvbmFyeTxzdHJpbmcsIENvbHVtbkZpbHRlclN0YXRlPigpO1xuICAgIHB1YmxpYyBhcHBsaWVkU29ydHM6IERpY3Rpb25hcnk8c3RyaW5nLCBDb2x1bW5Tb3J0U3RhdGU+ID0gbmV3IERpY3Rpb25hcnk8c3RyaW5nLCBDb2x1bW5Tb3J0U3RhdGU+KCk7XG4gICAgcHVibGljIGNvbHVtbnM6IENvbHVtbltdID0gW107XG4gICAgcHVibGljIGVkaXRhYmxlT3B0aW9uczogRWRpdGFibGVPcHRpb25zID0geyBlbmFibGVkOiBmYWxzZSB9O1xuICAgIHB1YmxpYyBmaWx0ZXJMb2FkJDogU3ViamVjdDx2b2lkPiA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gICAgcHVibGljIGdyaWRIZWFkZXJFbGVtZW50PzogSFRNTERpdkVsZW1lbnQ7XG4gICAgcHVibGljIGdyb3VwQ29sdW1uczogQ29sdW1uW10gPSBbXTtcbiAgICBwdWJsaWMgZ3JpZEdyb3VwRXhwYW5kU3RhdGU6IERpY3Rpb25hcnk8c3RyaW5nLCBEaWN0aW9uYXJ5PG51bWJlciwgYm9vbGVhbj4+ID0gbmV3IERpY3Rpb25hcnk8XG4gICAgICAgIHN0cmluZyxcbiAgICAgICAgRGljdGlvbmFyeTxudW1iZXIsIGJvb2xlYW4+XG4gICAgPigpO1xuICAgIHB1YmxpYyBpc0luRWRpdE1vZGU6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwdWJsaWMgcGFnZVN0YXRlOiB7IHBhZ2U6IG51bWJlcjsgc2tpcDogbnVtYmVyOyB0YWtlOiBudW1iZXIgfSA9IHsgcGFnZTogMSwgc2tpcDogMCwgdGFrZTogMTAgfTtcbiAgICBwdWJsaWMgcm93czogUm93W10gPSBbXTtcbiAgICBwdWJsaWMgc2VsZWN0ZWRLZXlzOiBFbnVtZXJhYmxlU2V0PHVua25vd24+ID0gbmV3IEVudW1lcmFibGVTZXQ8dW5rbm93bj4oKTtcbiAgICBwdWJsaWMgc2VsZWN0aW9uS2V5RmllbGQ6IHN0cmluZyA9IFwiXCI7IC8vIHNldCBieSBHcmlkU2VsZWN0YWJsZURpcmVjdGl2ZVxuICAgIHB1YmxpYyBzZWxlY3RhYmxlT3B0aW9uczogU2VsZWN0YWJsZU9wdGlvbnMgPSB7XG4gICAgICAgIGVuYWJsZWQ6IGZhbHNlLFxuICAgICAgICBtb2RlOiBcInNpbmdsZVwiXG4gICAgfTtcbiAgICBwdWJsaWMgc2VsZWN0ZWRLZXlzQ2hhbmdlOiBFdmVudEVtaXR0ZXI8dW5rbm93bltdPiA9IG5ldyBFdmVudEVtaXR0ZXI8dW5rbm93bltdPigpO1xuICAgIHB1YmxpYyBzZWxlY3RlZFJvd3M6IFJvd1tdID0gW107XG4gICAgcHVibGljIHNvcnRMb2FkJDogU3ViamVjdDx2b2lkPiA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gICAgcHVibGljIHNvcnRhYmxlT3B0aW9uczogU29ydGFibGVPcHRpb25zID0ge1xuICAgICAgICBlbmFibGVkOiBmYWxzZSxcbiAgICAgICAgbW9kZTogXCJzaW5nbGVcIixcbiAgICAgICAgYWxsb3dVbnNvcnQ6IGZhbHNlLFxuICAgICAgICBzaG93SW5kaWNlczogdHJ1ZVxuICAgIH07XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IoKSB7fVxuXG4gICAgcHVibGljIGxvYWRGaWx0ZXJzKGZpbHRlcnM6IENvbXBvc2l0ZUZpbHRlckRlc2NyaXB0b3JbXSk6IHZvaWQge1xuICAgICAgICBjb25zdCBuZXdBcHBsaWVkRmlsdGVycyA9IG5ldyBEaWN0aW9uYXJ5PHN0cmluZywgQ29sdW1uRmlsdGVyU3RhdGU+KCk7XG4gICAgICAgIGZvciAoY29uc3QgZmlsdGVyIG9mIGZpbHRlcnMpIHtcbiAgICAgICAgICAgIGNvbnN0IGZpbHRlcjEgPSBmaWx0ZXIuZmlsdGVyc1swXSBhcyBGaWx0ZXJEZXNjcmlwdG9yO1xuICAgICAgICAgICAgY29uc3QgZmlsdGVyMiA9IGZpbHRlci5maWx0ZXJzWzFdIGFzIEZpbHRlckRlc2NyaXB0b3I7XG4gICAgICAgICAgICBjb25zdCBjb2x1bW4gPSB0aGlzLmNvbHVtbnMuZmluZChjID0+IGMuZmllbGQgPT09IGZpbHRlcjEuZmllbGQpO1xuICAgICAgICAgICAgaWYgKGNvbHVtbiAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgbmV3QXBwbGllZEZpbHRlcnMuYWRkKGNvbHVtbi5maWVsZCwge1xuICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6IGZpbHRlcixcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyTWVudVZhbHVlOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTE6IGZpbHRlcjEgJiYgXCJ2YWx1ZVwiIGluIGZpbHRlcjEgPyBmaWx0ZXIxLnZhbHVlIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUyOiBmaWx0ZXIyICYmIFwidmFsdWVcIiBpbiBmaWx0ZXIyID8gZmlsdGVyMi52YWx1ZSA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wZXJhdG9yMTogZmlsdGVyMSA/IGZpbHRlcjEub3BlcmF0b3IgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBvcGVyYXRvcjI6IGZpbHRlcjIgPyBmaWx0ZXIyLm9wZXJhdG9yIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgbG9naWM6IGZpbHRlci5sb2dpYyB8fCBcImFuZFwiXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNvbHVtbnMuZm9yRWFjaChjID0+IChjLmZpbHRlcmVkID0gbmV3QXBwbGllZEZpbHRlcnMuY29udGFpbnNLZXkoYy5maWVsZCkpKTtcbiAgICAgICAgdGhpcy5hcHBsaWVkRmlsdGVycyA9IG5ld0FwcGxpZWRGaWx0ZXJzO1xuICAgICAgICB0aGlzLmZpbHRlckxvYWQkLm5leHQoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbG9hZFNlbGVjdGVkS2V5cyhzZWxlY3RlZEtleXM6IEl0ZXJhYmxlPHVua25vd24+KTogdm9pZCB7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRSb3dzID0gW107XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRLZXlzID0gbmV3IEVudW1lcmFibGVTZXQ8dW5rbm93bj4oc2VsZWN0ZWRLZXlzKTtcbiAgICAgICAgZm9yIChjb25zdCByb3cgb2YgdGhpcy5yb3dzKSB7XG4gICAgICAgICAgICBjb25zdCBmaWVsZERhdGEgPSB0aGlzLnNlbGVjdGlvbktleUZpZWxkID8gcm93LmRhdGFbdGhpcy5zZWxlY3Rpb25LZXlGaWVsZF0gOiByb3cuZGF0YTtcbiAgICAgICAgICAgIGlmIChmaWVsZERhdGEgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcm93LnNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZEtleXMuY29udGFpbnMoZmllbGREYXRhKTtcbiAgICAgICAgICAgIGlmIChyb3cuc2VsZWN0ZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkUm93cyA9IFsuLi50aGlzLnNlbGVjdGVkUm93cywgcm93XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBsb2FkU29ydHMoc29ydHM6IFNvcnREZXNjcmlwdG9yW10pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgbmV3QXBwbGllZFNvcnRzID0gbmV3IERpY3Rpb25hcnk8c3RyaW5nLCBDb2x1bW5Tb3J0U3RhdGU+KCk7XG4gICAgICAgIGZvciAoY29uc3QgW2luZGV4LCBzb3J0XSBvZiBzb3J0cy5lbnRyaWVzKCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbHVtbiA9IHRoaXMuY29sdW1ucy5maW5kKGMgPT4gYy5maWVsZCA9PT0gc29ydC5maWVsZCk7XG4gICAgICAgICAgICBpZiAoY29sdW1uICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICBuZXdBcHBsaWVkU29ydHMuYWRkKGNvbHVtbi5maWVsZCwge1xuICAgICAgICAgICAgICAgICAgICBzb3J0OiBzb3J0XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgY29sdW1uLnNvcnRJbmRleCA9IGluZGV4ICsgMTtcbiAgICAgICAgICAgICAgICBjb2x1bW4uc29ydERpcmVjdGlvbiA9IHNvcnQuZGlyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuYXBwbGllZFNvcnRzID0gbmV3QXBwbGllZFNvcnRzO1xuICAgICAgICB0aGlzLnNvcnRMb2FkJC5uZXh0KCk7XG4gICAgfVxuXG4gICAgcHVibGljIHNldEVkaXRhYmxlT3B0aW9ucyhvcHRpb25zOiBFZGl0YWJsZU9wdGlvbnMpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5lZGl0YWJsZU9wdGlvbnMgPSB7IC4uLnRoaXMuZWRpdGFibGVPcHRpb25zLCAuLi5vcHRpb25zIH07XG4gICAgfVxuXG4gICAgcHVibGljIHNldFJvd3ModmFsdWU6IGFueVtdKTogdm9pZCB7XG4gICAgICAgIHRoaXMucm93cyA9IEVudW1lcmFibGUuZnJvbSh2YWx1ZSlcbiAgICAgICAgICAgIC5zZWxlY3QociA9PiBuZXcgUm93KHIpKVxuICAgICAgICAgICAgLnRvQXJyYXkoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0U2VsZWN0YWJsZU9wdGlvbnMob3B0aW9uczogU2VsZWN0YWJsZU9wdGlvbnMpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zZWxlY3RhYmxlT3B0aW9ucyA9IHsgLi4udGhpcy5zZWxlY3RhYmxlT3B0aW9ucywgLi4ub3B0aW9ucyB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXRTb3J0YWJsZU9wdGlvbnMob3B0aW9uczogU29ydGFibGVPcHRpb25zKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc29ydGFibGVPcHRpb25zID0geyAuLi50aGlzLnNvcnRhYmxlT3B0aW9ucywgLi4ub3B0aW9ucyB9O1xuICAgIH1cbn1cbiJdfQ==