import { Enumerator } from "@mirei/ts-collections";
import { FilterUtils } from "../filter/FilterUtils";
export class Query {
    constructor(iterable) {
        this.iterable = iterable;
        this.enumerator = new QueryEnumerator(() => iterable);
    }
    *[Symbol.iterator]() {
        yield* this.iterable;
    }
    static from(iterable) {
        return new Query(iterable);
    }
    filter(filter, fieldSelector) {
        return this.enumerator.filter(filter, fieldSelector);
    }
    run() {
        return this.enumerator.toArray();
    }
    sort(descriptor, fieldSelector) {
        return this.enumerator.sort(descriptor, fieldSelector);
    }
}
export class QueryEnumerator extends Enumerator {
    constructor(iterable) {
        super(iterable);
    }
    filter(filter, fieldSelector) {
        return new QueryEnumerator(() => this.filterGenerator(filter, fieldSelector));
    }
    run() {
        return Array.from(this);
    }
    sort(descriptor, fieldSelector) {
        return new QueryEnumerator(() => this.sortGenerator(descriptor, fieldSelector));
    }
    *filterGenerator(filter, fieldSelector) {
        const predicate = filter.hasOwnProperty("field")
            ? FilterUtils.descriptorToPredicate(filter, fieldSelector)
            : FilterUtils.compositeDescriptorToPredicate(filter, fieldSelector);
        yield* this.where(predicate);
    }
    *sortGenerator(descriptor, fieldSelector) {
        let result = descriptor[0].dir === "asc"
            ? this.orderBy(d => (fieldSelector ? fieldSelector(d) : d)[descriptor[0].field], descriptor[0].sort)
            : this.orderByDescending(d => (fieldSelector ? fieldSelector(d) : d)[descriptor[0].field], descriptor[0].sort);
        for (let i = 1; i < descriptor.length; i++) {
            result =
                descriptor[i].dir === "asc"
                    ? result.thenBy(d => (fieldSelector ? fieldSelector(d) : d)[descriptor[i].field], descriptor[i].sort)
                    : result.thenByDescending(d => (fieldSelector ? fieldSelector(d) : d)[descriptor[i].field], descriptor[i].sort);
        }
        yield* result;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUXVlcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9tb25hLXVpL3NyYy9saWIvcXVlcnkvY29yZS9RdWVyeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsVUFBVSxFQUFZLE1BQU0sdUJBQXVCLENBQUM7QUFDN0QsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBV3BELE1BQU0sT0FBTyxLQUFLO0lBR2QsWUFBcUMsUUFBcUI7UUFBckIsYUFBUSxHQUFSLFFBQVEsQ0FBYTtRQUN0RCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksZUFBZSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFFRCxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztRQUNkLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDekIsQ0FBQztJQUVNLE1BQU0sQ0FBQyxJQUFJLENBQUksUUFBcUI7UUFDdkMsT0FBTyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRU0sTUFBTSxDQUFDLE1BQW9ELEVBQUUsYUFBZ0M7UUFDaEcsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDekQsQ0FBQztJQUVNLEdBQUc7UUFDTixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDckMsQ0FBQztJQUVNLElBQUksQ0FBQyxVQUE0QixFQUFFLGFBQWdDO1FBQ3RFLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQzNELENBQUM7Q0FDSjtBQUVELE1BQU0sT0FBTyxlQUFtQixTQUFRLFVBQWE7SUFDakQsWUFBbUIsUUFBMkI7UUFDMUMsS0FBSyxDQUFD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dCB7IENvbXBvc2l0ZUZpbHRlckRlc2NyaXB0b3IsIEZpbHRlckRlc2NyaXB0b3IgfSBmcm9tIFwiLi4vZmlsdGVyL0ZpbHRlckRlc2NyaXB0b3JcIjtcbmltcG9ydCB7IEVudW1lcmF0b3IsIFNlbGVjdG9yIH0gZnJvbSBcIkBtaXJlaS90cy1jb2xsZWN0aW9uc1wiO1xuaW1wb3J0IHsgRmlsdGVyVXRpbHMgfSBmcm9tIFwiLi4vZmlsdGVyL0ZpbHRlclV0aWxzXCI7XG5pbXBvcnQgeyBTb3J0RGVzY3JpcHRvciB9IGZyb20gXCIuLi9zb3J0L1NvcnREZXNjcmlwdG9yXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVF1ZXJ5PFQ+IGV4dGVuZHMgSXRlcmFibGU8VD4ge1xuICAgIGZpbHRlcihmaWx0ZXI6IEZpbHRlckRlc2NyaXB0b3IgfCBDb21wb3NpdGVGaWx0ZXJEZXNjcmlwdG9yLCBmaWVsZFNlbGVjdG9yPzogU2VsZWN0b3I8VCwgYW55Pik6IElRdWVyeTxUPjtcblxuICAgIHJ1bigpOiBUW107XG5cbiAgICBzb3J0KGRlc2NyaXB0b3I6IFNvcnREZXNjcmlwdG9yW10sIGZpZWxkU2VsZWN0b3I/OiBTZWxlY3RvcjxULCBhbnk+KTogSVF1ZXJ5PFQ+O1xufVxuXG5leHBvcnQgY2xhc3MgUXVlcnk8VD4gaW1wbGVtZW50cyBJUXVlcnk8VD4ge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZW51bWVyYXRvcjogUXVlcnlFbnVtZXJhdG9yPFQ+O1xuXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGl0ZXJhYmxlOiBJdGVyYWJsZTxUPikge1xuICAgICAgICB0aGlzLmVudW1lcmF0b3IgPSBuZXcgUXVlcnlFbnVtZXJhdG9yKCgpID0+IGl0ZXJhYmxlKTtcbiAgICB9XG5cbiAgICAqW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmF0b3I8VD4ge1xuICAgICAgICB5aWVsZCogdGhpcy5pdGVyYWJsZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGZyb208VD4oaXRlcmFibGU6IEl0ZXJhYmxlPFQ+KTogSVF1ZXJ5PFQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBRdWVyeShpdGVyYWJsZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGZpbHRlcihmaWx0ZXI6IEZpbHRlckRlc2NyaXB0b3IgfCBDb21wb3NpdGVGaWx0ZXJEZXNjcmlwdG9yLCBmaWVsZFNlbGVjdG9yPzogU2VsZWN0b3I8VCwgYW55Pik6IElRdWVyeTxUPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmVudW1lcmF0b3IuZmlsdGVyKGZpbHRlciwgZmllbGRTZWxlY3Rvcik7XG4gICAgfVxuXG4gICAgcHVibGljIHJ1bigpOiBUW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5lbnVtZXJhdG9yLnRvQXJyYXkoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc29ydChkZXNjcmlwdG9yOiBTb3J0RGVzY3JpcHRvcltdLCBmaWVsZFNlbGVjdG9yPzogU2VsZWN0b3I8VCwgYW55Pik6IElRdWVyeTxUPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmVudW1lcmF0b3Iuc29ydChkZXNjcmlwdG9yLCBmaWVsZFNlbGVjdG9yKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBRdWVyeUVudW1lcmF0b3I8VD4gZXh0ZW5kcyBFbnVtZXJhdG9yPFQ+IGltcGxlbWVudHMgSVF1ZXJ5PFQ+IHtcbiAgICBwdWJsaWMgY29uc3RydWN0b3IoaXRlcmFibGU6ICgpID0+IEl0ZXJhYmxlPFQ+KSB7XG4gICAgICAgIHN1cGVyKGl0ZXJhYmxlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZmlsdGVyKGZpbHRlcjogRmlsdGVyRGVzY3JpcHRvciB8IENvbXBvc2l0ZUZpbHRlckRlc2NyaXB0b3IsIGZpZWxkU2VsZWN0b3I/OiBTZWxlY3RvcjxULCBhbnk+KTogSVF1ZXJ5PFQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBRdWVyeUVudW1lcmF0b3IoKCkgPT4gdGhpcy5maWx0ZXJHZW5lcmF0b3IoZmlsdGVyLCBmaWVsZFNlbGVjdG9yKSk7XG4gICAgfVxuXG4gICAgcHVibGljIHJ1bigpOiBUW10ge1xuICAgICAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc29ydChkZXNjcmlwdG9yOiBTb3J0RGVzY3JpcHRvcltdLCBmaWVsZFNlbGVjdG9yPzogU2VsZWN0b3I8VCwgYW55Pik6IElRdWVyeTxUPiB7XG4gICAgICAgIHJldHVybiBuZXcgUXVlcnlFbnVtZXJhdG9yKCgpID0+IHRoaXMuc29ydEdlbmVyYXRvcihkZXNjcmlwdG9yLCBmaWVsZFNlbGVjdG9yKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSAqZmlsdGVyR2VuZXJhdG9yKFxuICAgICAgICBmaWx0ZXI6IEZpbHRlckRlc2NyaXB0b3IgfCBDb21wb3NpdGVGaWx0ZXJEZXNjcmlwdG9yLFxuICAgICAgICBmaWVsZFNlbGVjdG9yPzogU2VsZWN0b3I8VCwgYW55PlxuICAgICk6IEl0ZXJhYmxlPFQ+IHtcbiAgICAgICAgY29uc3QgcHJlZGljYXRlID0gZmlsdGVyLmhhc093blByb3BlcnR5KFwiZmllbGRcIilcbiAgICAgICAgICAgID8gRmlsdGVyVXRpbHMuZGVzY3JpcHRvclRvUHJlZGljYXRlKGZpbHRlciBhcyBGaWx0ZXJEZXNjcmlwdG9yLCBmaWVsZFNlbGVjdG9yKVxuICAgICAgICAgICAgOiBGaWx0ZXJVdGlscy5jb21wb3NpdGVEZXNjcmlwdG9yVG9QcmVkaWNhdGUoZmlsdGVyIGFzIENvbXBvc2l0ZUZpbHRlckRlc2NyaXB0b3IsIGZpZWxkU2VsZWN0b3IpO1xuICAgICAgICB5aWVsZCogdGhpcy53aGVyZShwcmVkaWNhdGUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgKnNvcnRHZW5lcmF0b3IoZGVzY3JpcHRvcjogU29ydERlc2NyaXB0b3JbXSwgZmllbGRTZWxlY3Rvcj86IFNlbGVjdG9yPFQsIGFueT4pOiBJdGVyYWJsZTxUPiB7XG4gICAgICAgIGxldCByZXN1bHQgPVxuICAgICAgICAgICAgZGVzY3JpcHRvclswXS5kaXIgPT09IFwiYXNjXCJcbiAgICAgICAgICAgICAgICA/IHRoaXMub3JkZXJCeShcbiAgICAgICAgICAgICAgICAgICAgICBkID0+IChmaWVsZFNlbGVjdG9yID8gZmllbGRTZWxlY3RvcihkKSA6IChkIGFzIGFueSkpW2Rlc2NyaXB0b3JbMF0uZmllbGRdLFxuICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0b3JbMF0uc29ydFxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIDogdGhpcy5vcmRlckJ5RGVzY2VuZGluZyhcbiAgICAgICAgICAgICAgICAgICAgICBkID0+IChmaWVsZFNlbGVjdG9yID8gZmllbGRTZWxlY3RvcihkKSA6IChkIGFzIGFueSkpW2Rlc2NyaXB0b3JbMF0uZmllbGRdLFxuICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0b3JbMF0uc29ydFxuICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBkZXNjcmlwdG9yLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICByZXN1bHQgPVxuICAgICAgICAgICAgICAgIGRlc2NyaXB0b3JbaV0uZGlyID09PSBcImFzY1wiXG4gICAgICAgICAgICAgICAgICAgID8gcmVzdWx0LnRoZW5CeShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgZCA9PiAoZmllbGRTZWxlY3RvciA/IGZpZWxkU2VsZWN0b3IoZCkgOiAoZCBhcyBhbnkpKVtkZXNjcmlwdG9yW2ldLmZpZWxkXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRvcltpXS5zb3J0XG4gICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICA6IHJlc3VsdC50aGVuQnlEZXNjZW5kaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICBkID0+IChmaWVsZFNlbGVjdG9yID8gZmllbGRTZWxlY3RvcihkKSA6IChkIGFzIGFueSkpW2Rlc2NyaXB0b3JbaV0uZmllbGRdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdG9yW2ldLnNvcnRcbiAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHlpZWxkKiByZXN1bHQ7XG4gICAgfVxufVxuIl19